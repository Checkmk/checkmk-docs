// -*- coding: utf-8 -*-
include::global_attr.adoc[]
= Appliance im Cluster-Betrieb
:revdate: draft
:title: Appliance im Cluster-Betrieb
:description: Anleitung zum Betrieb eines Failover-Clusters.

{related-start}
xref:appliance_usage[Appliance einrichten und nutzen] 
xref:appliance_rack_config[Besonderheiten der Appliance auf Racks]
xref:checkmk_getting_started[Schnelleinstieg ins Monitoring]
{related-end}

== Grundlagen

Sie können zwei {CMK}-Appliances zu einem Failover-Cluster zusammenschließen.
Dabei werden alle Konfigurationen und Daten zwischen den beiden Geräten abgeglichen.
Die Geräte, die als Cluster verbunden sind, nennt man auch Knoten (Nodes).
Einer der Knoten im Cluster übernimmt die aktive Rolle, führt also die Aufgaben des Clusters aus.
Beide Knoten tauschen sich ständig über ihren Zustand aus.
Sobald der inaktive Knoten erkennt, dass der aktive Knoten seine Aufgaben nicht mehr erfüllen kann, z.B. aufgrund eines Ausfalls,
übernimmt er dessen Aufgaben und wird selbst zum aktiven Knoten.

Der Failover-Cluster ist dazu da, die Verfügbarkeit Ihrer Monitoring-Installation zu erhöhen, indem diese gegen Hardwareausfälle eines Geräts oder einzelner Komponenten abgesichert wird.
Die Clusterung ersetzt hingegen keine Datensicherung und fängt keine logischen Fehler ab.

In den folgenden Situationen sorgt der Cluster für eine geringere Ausfallzeit, indem der inaktive Knoten die Ressourcen übernimmt:

* Wenn das RAID in einem {CMK}-Rack nicht mehr zugreifbar ist.
* Wenn das bisher aktive Gerät nicht mehr erreichbar (ausgefallen) ist.
* Wenn das bisher aktive Gerät das „externe“ Netzwerk nicht mehr erreichen kann, der inaktive Knoten hingegen schon.
* Wenn Sie ein Firmware-Update auf den Knoten durchführen.

Funktionieren kann das Cluster im Ernstfall natürlich nur, wenn die Knoten über separate Switches und Stromversorgungen betrieben werden!

== Voraussetzungen

Damit Sie einen Cluster aufbauen können, brauchen Sie zunächst zwei kompatible {CMK}-Appliances.
Folgende Modelle können miteinander geclustert werden:

* 2 x {CMK} rack1
* 2 x {CMK} rack4
* 2 x {CMK} virt1
* 1 x {CMK} rack1/rack4 und 1x {CMK} virt1

Weiterhin müssen die beiden Geräte eine xref:appliance_usage#cma_webconf_firmware[kompatible Firmware] nutzen.
Kombinieren Sie eine virt1-Appliance mit einem physischen Rack, muss die virtuelle Maschine die gleichen Spezifikationen wie der physische Server aufweisen -- ansonsten könnte sie abstürzen, wenn sie die Last vom Rack übernimmt.

Die Geräte müssen mit mindestens zwei voneinander unabhängigen Netzwerkverbindungen verkabelt sein.
Eine dieser Verbindungen dient der normalen Netzwerkanbindung, die zweite der Synchronisation zwischen den Cluster-Knoten.
Die Sync-Verbindung sollte möglichst direkt zwischen den Geräten, zumindest aber über ein separates Netzwerk laufen.

Um die Verfügbarkeit der Netzwerkverbindungen zu erhöhen, sollten Sie eine Bonding-Konfiguration erstellen, die alle vier Netzwerkanschlüsse der {CMK}-Racks nutzt, statt lediglich zwei einzelne Anschlüsse zu konfigurieren.
Dabei verwenden Sie die Schnittstellen `LAN1` und `LAN2` für den Anschluss an Ihr Netzwerk und die Schnittstellen `LAN3` und `LAN4` für die direkte Sync-Verbindung zwischen der Geräten.

*Virtuelle Maschinen:* Technisch ist es durchaus möglich, zwei virt1-Instanzen zu clustern.
Da die Cluster-Funktion jedoch darauf ausgelegt ist, Hardwareausfälle zu kompensieren, empfehlen wir dies nicht für den produktiven Betrieb.
Für Hochverfügbarkeit bieten Virtualisierungsplattformen wie VMware ESXi eigene Funktionen.
Jedoch können Sie die Verhaltensweise und Konfiguration eines Clusters mit zwei virtuellen Maschinen sehr einfach testen.
Dazu eigenen sich auch "Desktop-Virtualisierer" wie VirtualBox oder VMware Workstation Player.
Auf die Bonding-Konfiguration können Sie dabei verzichten.
Statt also wie im Folgenden gezeigt das Bonding einzurichten, nutzen Sie einfach die ungenutzte zweite Netzwerkschnittstelle.
Beim eigentlichen Clustern wählen Sie dann schlicht Ihre beiden einzelnen Schnittstellen statt der gebündelten Bonding-Schnittstellen.

== Konfiguration des Clusters

Diese Anleitung geht davon aus, dass Sie beide Geräte bereits so weit vorkonfiguriert haben, dass Sie die Web-Oberfläche mit einem Webbrowser öffnen können.

Vor der eigentlichen Einrichtung des Clusters müssen Sie zunächst beide Geräte vorbereiten.
Dabei müssen Sie hauptsächlich die Netzwerkkonfiguration so anpassen, dass die oben genannten Anforderungen erfüllt werden.

Im Folgenden wird die Konfiguration eines Clusters mit zwei Bonding-Schnittstellen gezeigt, das dem folgendem Schaubild entspricht.

// ML: to be redrawn
image::cluster.png[]

Die im Schaubild verwendeten Schnittstellenbezeichnungen [.guihint]#LAN1#, [.guihint]#LAN2# usw. entsprechen den Bezeichnungen der physikalischen Schnittstellen am Gerät.
Im Betriebssystem entspricht [.guihint]#LAN1# dem Gerät [.guihint]#eth0#, [.guihint]#LAN2# dem Gerät [.guihint]#eth1# usw.
Die verwendeten IP-Adressen sind freilich beliebig.
Achten Sie jedoch darauf, dass das interne Cluster-Netz ([.guihint]#bond1# im Schaubild) ein anderes IP-Netz verwendet, als das „externe“ Netz ([.guihint]#bond0# im Schaubild).

*Hinweis:* Die folgenden Screenshots wurden mit einem virt1-Cluster erzeugt -- entsprechend unterscheiden sich die Namen der Netzwerkschnitstellen.


=== Netzwerkkonfiguration

Öffnen Sie die Web-Oberfläche des ersten Knotens, wählen Sie die Geräteeinstellungen und oben [.guihint]#Network Settings.#
Sie befinden sich jetzt auf der Seite zur Konfiguration der Netzwerkeinstellungen. 
Hier stehen Ihnen zwei Modi zur Verfügung.

Der [.guihint]#Simple Mode,# mit dem Sie nur [.guihint]#LAN1# Ihres Geräts konfigurieren können, ist standardmäßig aktiviert.
(Das Resultat der Konfiguration über die Textkonsole während der initialen Einrichtung der Appliance.)

image::cma_de_net_1_2.png[]

Für die Clusterung wird der _erweiterte Modus_ benötigt.
Um diesen Modus zu aktivieren, klicken Sie oben auf den Button [.guihint]#Advanced Mode# und bestätigen Sie die Sicherheitsabfrage.

Auf der folgenden Seite werden Ihnen alle im Gerät verfügbaren Netzwerkschnittstellen angezeigt.
Nur die Standardschnittstelle (auf den Racks [.guihint]#eth0# über die Buchse [.guihint]#LAN1#), hier im Screenshot _enp0s32_, hat aktuell eine Konfiguration.
Diese wurde vom _einfachen Modus_ übernommen.

[{image-border}]
image::cma_de_net_2_3.png[]

Erstellen Sie nun durch Klick auf [.guihint]#Create Bonding# die erste Bonding-Schnittstelle [.guihint]#bond0.#
Tragen Sie dazu im darauf folgenden Dialog alle Daten entsprechend des folgenden Screenshots ein und bestätigen Sie den Dialog mit [.guihint]#Save.#

image::cma_de_net_3_2.png[]

Erstellen Sie nun die zweite Bonding-Schnittstelle [.guihint]#bond1# mit der passenden Konfiguration für die direkte Sync-Verbindung.

image::cma_de_net_4_2.png[]

Nachdem Sie die beiden Bonding-Schnittstellen erstellt haben, sehen Sie im Dialog zur Netzwerkkonfiguration noch einmal alle getätigten Einstellungen zu den Netzwerkschnitstellen &#8230;

image::cma_de_net_5_a.png[]

&#8230; sowie zu den erstellten Bondings:

image::cma_de_net_5_b.png[]

Wenn Sie alle Schritte zur Konfiguration erfolgreich abgeschlossen haben, machen Sie die Einstellungen mit einem Klick auf [.guihint]#Activate Changes#
wirksam.
Daraufhin werden die neuen Netzwerkeinstellungen geladen.
Nach wenigen Sekunden zeigt die Netzwerkkonfiguration überall den Status OK, bei den echten Netzwerkschnittstellen ...

image::cma_de_net_6_a.png[]

&#8230; sowie wiederum bei den Bondings:

image::cma_de_net_6_b.png[]

Wiederholen Sie die Konfiguration der Netzwerkeinstellungen mit den passenden Einstellungen nun auch auf Ihrem zweiten Gerät.

=== Hostnamen

Geräte, die in einem Cluster verbunden werden sollen, müssen unterschiedliche Hostnamen haben.
Diese können Sie jetzt in den xref:appliance_usage#cma_webconf_system_settings[Geräteeinstellungen] festlegen.
Im Beispiel bekommen die Geräte die Namen `cma1` und `cma2`.

=== Verbinden des Clusters

Nachdem Sie nun die Vorbereitungen abgeschlossen haben, können Sie mit dem Einrichten des Clusters fortfahren.
Öffnen Sie dazu in der Web-Oberfläche im Hauptmenü des ersten Geräts (hier `cma1`) das Modul [.guihint]#Clustering# und klicken Sie dort auf [.guihint]#Create Cluster.#

Tragen Sie im Dialog zum Erstellen des Clusters nun die entsprechende Konfiguration ein und bestätigen Sie den Dialog mit [.guihint]#Save.#
Wichtig ist hier vor allem die [.guihint]#Cluster IP-Address,# über die Sie später auf das Cluster zugreifen.
Wenn Sie zu diesem Dialog weiterführende Informationen benötigen, rufen Sie die Online-Hilfe über das Icon neben dem {CMK}-Logo auf.

image::cma_de_cluster_1_2.png[]

Auf der folgenden Seite können Sie die beiden Geräte zu einem Cluster verbinden.
Hierzu müssen Sie das Passwort der Web-Oberfläche des zweiten Geräts eingeben.
Dieses wird einmalig dazu genutzt, die Verbindung zwischen den beiden Geräten herzustellen.
Bestätigen Sie anschließend die Sicherheitsabfrage, wenn Sie sich sicher sind, dass Sie die Daten des angezeigten Zielgeräts überschreiben wollen.

image::cma_de_cluster_2_2.png[]

Nachdem dieser Verbindungsaufbau erfolgreich war, wird mit der Synchronisation des Clusters begonnen.
Den aktuellen Status können Sie sich auf der Cluster-Seite anzeigen lassen.
Noch während dieser Synchronisation werden alle Ressourcen, u.a. auch Ihre möglicherweise bestehenden Monitoring-Instanzen, auf dem ersten Knoten gestartet.

image::cma_de_cluster_4_2.png[]

Ab Sofort können Sie mit Hilfe der Cluster-IP-Adresse (hier `192.168.178.110`) auf die Ressourcen des Clusters, z.B. Ihre Monitoring-Instanzen, zugreifen -- egal von welchem Knoten die Ressourcen gerade gehalten werden.

== Der Status des Clusters

Nach Abschluss der ersten Synchronisation ist Ihr Cluster voll einsatzbereit.
Auf der Cluster-Seite können Sie den Zustand jederzeit einsehen.

image::cma_de_cluster_5_2.png[]

Auch mit Hilfe der Statusansicht der Konsole können Sie den aktuellen Zustand des Clusters im Kasten [.guihint]#Cluster# in zusammengefasster Form einsehen.
Die Rolle des jeweiligen Knotens wird hinter dem aktuellen Status mit [.guihint]#(M)# für den aktiven Host (Main) und [.guihint]#(S)# für den passiven Host (Subordinate) dargestellt.

image::cma_de_cluster_6_2.png[]

== Besonderheiten im Cluster

=== Zugriff auf Ressourcen

Alle Anfragen an die Monitoring-Instanzen, wie z.B. Zugriffe auf die Web-Oberfläche, aber auch eingehende Meldungen wie z.B. SNMP-Traps oder
Syslog-Meldungen an die Event-Console oder Anfragen an Livestatus, sollten im Normalfall immer über die Cluster-IP-Adresse gehen.

Nur in Ausnahmefällen, wie z.B. Fehlerdiagnosen oder Updates eines bestimmen Knotens, sollten Sie direkt auf die einzelnen Knoten zugreifen müssen.

=== Geräteeinstellungen

Die Einstellungen, wie z.B. Zeitsynchronisation oder Einstellungen zur Namensauflösung, die bisher auf den einzelnen Geräten unabhängig voneinander gemacht wurden, werden im Cluster zwischen den beiden Knoten synchronisiert.

Sie können diese Einstellungen aber nur auf dem jeweils aktiven Knoten bearbeiten.
Auf dem inaktiven Knoten sind die Einstellungen gesperrt.

Es gibt einige gerätespezifische Einstellungen, wie z.B. die des Management-Interfaces des {CMK} rack1, die Sie zu jeder Zeit auf den einzelnen
Geräten anpassen können.

=== IP-Addressen oder Hostnamen der Knoten

Um die IP-Konfiguration der einzelnen Knoten bearbeiten zu können, müssen Sie zunächst die Verbindung zwischen den Knoten lösen.
Hierzu klicken Sie auf der Cluster-Seite auf [.guihint]#Disconnect Cluster.#
Anschließend können Sie über die Web-Oberfläche der einzelnen Knoten die gewünschten Einstellungen anpassen.

Nachdem Sie die Anpassungen abgeschlossen haben, müssen Sie nun auf der Cluster-Seite [.guihint]#Reconnect Cluster# wählen.
Wenn sich die Knoten erfolgreich wieder-verbinden können, nimmt der Cluster den Betrieb nach wenigen Minuten wieder auf.
Den Status können Sie auf der Cluster-Seite einsehen.

=== {CMK}-Versionen und Monitoring-Instanzen verwalten

Auch die Monitoring-Instanzen und {CMK}-Versionen werden zwischen den beiden Knoten synchronisiert.
Diese können Sie nur in der Web-Oberfläche des aktiven Knotens modifizieren -- sowohl über dessen eigene als auch über die Cluster-IP-Adresse.

== Administrative Aufgaben

[#majorfirmwareupdate]
=== Update von 1.4 auf 1.5
Im Gegensatz zum folgend beschriebenen Firmware-Update innerhalb kompatibler Versionen, also beispielsweise 1.5.1 auf 1.5.2, müssen Sie beim Update von 1.4-Versionen auf die aktuellen 1.5-Versionen etwas anders vorgehen.
Der Grund: Die 1.5 basiert auf einer neuen Debian-Version.
Kurz gesagt heißt das, dass Sie das Cluster kurzzeitig komplett offline nehmen müssen - Sie bekommen also eine Downtime.
Bei regulären Updates genügt es, einzelne Nodes des Clusters in den Wartungsmodus zu versetzen, um die Aktualisierung durchzuführen.
Bei diesem Major-Update auf 1.5 gehen Sie wie folgt vor:

- Trennen Sie die Nodes über [.guihint]#Clustering > Disconnect Cluster# vom Cluster.
- Aktualisieren Sie die Nodes nacheinander wie xref:cma_webconf_firmware[oben] beschrieben.
- Verbinden Sie die Nodes über [.guihint]#Clustering > Reconnect Cluster# wieder zum Cluster.
- Prüfen Sie, ob Ihre Instanzen kompatible Checkmk-Versionen nutzen und aktualisieren Sie bei Bedarf wie xref:update_site[oben] beschrieben.

=== Firmware-Update im Cluster


Die Firmware-Version eines Geräts wird auch im Cluster-Betrieb nicht synchronisiert.
Das Update geschieht also pro Knoten.
Sie haben jedoch den Vorteil, dass der eine Knoten weiterhin das Monitoring durchführen kann, während der andere Knoten aktualisiert wird.

Bei einem Update auf eine kompatible Firmware-Version sollten Sie stets wie folgt vorgehen:

Öffnen Sie zunächst das Modul [.guihint]#Clustering# in der Web-Oberfläche des Knotens, der aktualisiert werden soll.

Klicken Sie nun auf das Herz-Symbol in der Spalte dieses Knotens und bestätigen Sie die folgende Sicherheitsabfrage.
Dadurch setzen Sie den Knoten in den Wartungszustand.

Knoten, die sich im Wartungszustand befinden, geben alle Ressourcen frei, die aktuell auf dem Knoten aktiv sind, woraufhin der andere Knoten diese 	kübernimmt.

Während sich ein Knoten im Wartungszustand befindet, ist der Cluster nicht ausfallsicher.
Wenn jetzt also der aktive Knoten ausgeschaltet wird, übernimmt der inaktive Knoten, der sich im Wartungszustand befindet, _nicht_ die Ressourcen.
Sollten Sie nun auch noch den zweiten Knoten in den Wartungszustand setzen, werden alle Ressourcen heruntergefahren.
Diese werden erst wieder aktiviert, wenn ein Knoten aus dem Wartungszustand geholt wird.
Den Wartungszustand müssen Sie stets wieder manuell entfernen.

Wenn die Cluster-Seite Folgendes zeigt, sehen Sie, dass sich der Knoten im Wartungszustand befindet.

image::cma_de_cluster_7_2.png[]

Nun können Sie auf diesem Knoten, wie auf nicht geclusterten Geräten auch, das link:appliance_usage.html#cma_webconf_firmware[Firmware-Update] durchführen.

Öffnen Sie, nachdem Sie das Firmware-Update erfolgreich durchgeführt haben, wieder die Cluster-Seite.
Entfernen Sie den Wartungszustand des aktualisierten Geräts.
Das Gerät fügt sich anschließend automatisch wieder in den Cluster ein, womit der Cluster wieder voll funktionsfähig ist.

image::cma_de_cluster_5_2.png[]

Wir empfehlen, auf beiden Knoten die gleiche Firmware-Version zu betreiben.
Daher sollten Sie im Anschluss die gleiche Prozedur für den anderen Knoten wiederholen.

=== Cluster auflösen

Es ist möglich, die Knoten aus einem Cluster zu lösen und einzeln weiter zu betreiben.
Dabei können Sie auf beiden Geräten die synchronisierte Konfiguration weiter nutzen oder z.B. eines der Geräte wieder auf den Werkszustand zurücksetzen und neu konfigurieren.

Sie können einen oder beide Knoten im laufenden Betrieb aus dem Cluster entfernen.
Wenn Sie beide Knoten mit den aktuellen Daten weiterverwenden wollen, müssen Sie vorher sicherstellen, dass die Synchronisation der Daten ordnungsgemäß funktioniert.
Dies sehen Sie auf der Cluster-Seite.

Um einen Cluster aufzulösen, klicken Sie auf der Cluster-Seite der Web-Oberfläche auf [.guihint]#Disband Cluster#.
Beachten Sie den Text der folgenden Sicherheitsabfrage.
Dieser gibt in den verschiedenen Situationen Aufschluss darüber, in welchem Zustand sich das jeweilige Gerät nach dem Auflösen der Verbindung befinden wird.

image::cma_de_cluster_8_2.png[]

Die Trennung der Geräte muss auf beiden Knoten separat durchgeführt werden, damit zukünftig beide Geräte einzeln betrieben werden können.

Wenn Sie nur eines der Geräte zukünftig verwenden wollen, lösen Sie den Cluster auf dem Gerät, das Sie weiterhin verwenden wollen und stellen Sie auf dem anderen Gerät anschließend den Werkszustand wieder her.

Nachdem Sie einen Knoten aus dem Cluster getrennt haben, werden die Monitoring-Instanzen nicht automatisch gestartet.
Das müssen Sie im Anschluss bei Bedarf manuell erledigen.

=== Ein Gerät austauschen

Wenn die Festplatten des alten Geräts in Ordnung sind, können Sie diese aus dem alten Gerät in das neue Gerät einbauen und das neue Gerät genau so verkabeln, wie das alte Gerät verkabelt war -- und es anschließend einschalten.
Nach dem Start fügt sich das neue Gerät wieder so in den Cluster ein wie das alte Gerät.

Wenn Sie ein altes Gerät komplett durch ein neues Gerät ersetzen wollen, sollten Sie so vorgehen, wie wenn Sie den Cluster komplett auflösen (siehe vorheriges Kapitel).
Wählen Sie dazu eines der bisherigen Geräte aus, lösen Sie dieses aus dem Cluster und erstellen Sie einen neuen Cluster mit diesem und dem neuen Gerät.


== Fehlerdiagnose und -behebung

=== Logging

Die Cluster-Verwaltung geschieht weitestgehend automatisch.
Dabei entscheiden automatische Prozesse auf den Knoten, auf welchem Gerät welche Ressourcen gestartet und gestoppt werden sollen.
Dieses Verhalten wird in Form von Logeinträgen detailliert protokolliert.
Diese Einträge erreichen Sie von der Cluster-Seite aus über den Knopf [.guihint]#Cluster Log.#

Bitte beachten Sie, dass diese Einträge, genau wie die anderen Systemmeldungen, bei einem Neustart des Geräts verloren gehen.
Wenn Sie die Meldungen darüber hinaus erhalten möchten, können Sie sich die aktuelle Logdatei über Ihren Browser herunterladen oder dauerhaft eine Weiterleitung der Logmeldungen an einen Syslog-Server einrichten.
