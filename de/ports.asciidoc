// -*- coding: utf-8 -*-
include::global_attr.adoc[]
= Von {CMK} genutzte Ports
// MA: Wie im Weekly besprochen, wollen wir lieber das Schlagwort am Anfang stehen haben.
:revdate: draft
:title: Von {CMK} genutzte Ports
:description: {CMK} nutzt für die Kommunikation einige Ports, diesen müssen freigegeben sein.

{related-start}
xref:install_packages#[Grundsätzliches zur Installation von {CMK}]
xref:wato#[Die Konfiguration von {CMK}]
xref:wato_monitoringagents#[Monitoring-Agenten]
{related-end}


== Übersicht der wesentlichen Ports
// MA: Warum nicht nur "Übersicht"? Der Rest scheint mir redundant zu sein.

Damit {CMK} die konfigurierten Hosts und Services überwachen kann, ist unter anderem der reibungsfreie Zugriff auf einige Ports nötig.
// MA: Okay.... aber warum?
Diese müssen gegebenenfalls in der Firewall freigegeben werden.
Es sind jedoch nicht immer alle Ports notwendig.
// MA: Alle Ports von 1-65536 oder die unten erwähnten?
Abhängig von der Konfiguration können einige davon entfallen.
// MA: Abhängig von welcher Konfiguration?

Neben der Hilfe bei der Firewallkonfiguration soll diese Liste einen Überblick verschaffen, welche Ports beim Einsatz von {CMK} in Container-Umgebungen an den Port des jeweiligen Containers gebunden werden müssen.
// MA: Der Zusammenhang zum ersten Abschnitt ist mir nicht klar.

*Hinweis:* Die Mehrheit der hier aufgeführten Portnummern sind Standardports. Diese können jederzeit manuell auf andere Ports umgestellt werden. Diejenigen Ports, die nicht standardmässig aktiv sind, sondern stattdessen bei Bedarf freigegeben werden müssen, sind zusätzlich mit einem Vermerk gekennzeichnet.

== Ports im regulären Monitoring
// MA: Was ist denn ein irreguläres Monitoring?

[#host_incoming_cmk_outgoing]
=== Eingehende Ports auf dem überwachten Host (erreichbar durch {CMK}-Server)
// MA: Im Folgenden wird immmer nur über eingehend Ports gesprochen (abgesehen von "Weitere Ports"). Kann man das nicht vorher abfangen und dann in den Titeln weglassen?
// MA: Die Klammer wird ja im nachfolgenden Satz beschrieben. Muss das zusätzlich in den Titel?

Die folgenden Ports auf überwachten Hosts müssen vom {CMK}-Server oder den für einen Host im Monitoring zuständigen Remote-Instanzen aus erreichbar sein.
// MA: Ist "Remote-Instanzen" nicht eine Untermenge von "Checkmk-Server"?
// MA: Weshalb sprechen wir hier von Remote-Instanzen, wenn wir weiter unten ein explizites Kapitel darüber haben?

[cols="10,10,~,~",options="header"]
|===
|Port |Protokoll |Bezeichnung |ergänzende Informationen
|161 |UDP |xref:glossar#snmp[Simple Network Management Protocol (SNMP)]|Via SNMP überwachte Hosts erhalten über diesen Port die Anforderung `GET-REQUEST`
|6556 |TCP |xref:glossar#agent[Agent] |Via {CMK}-Agent überwachte Hosts werden über diesen Port abgefragt, die Kommunikation erfolgt im xref:agent_linux_legacy#[Klartext] oder xref:wato_monitoringagents#[TLS verschlüsselt]
// MA: Ist der Zusatz "im Klartext oder TLS verschlüsselt" relevant für das Verständnis, weswegen ich den Port brauche und was passiert, wenn ich ihn nicht freischalte?
| | |eventuell weitere Ports |z. B. für xref:glossar#active_check[aktive Checks] |
// MA: Irgendwie nicht so richtig hilfreich. Gehört das wirklich in die Tabelle?
|===

Die Überwachung mit Spezialagenten kann erfordern, andere/weitere Ports zu öffnen.
So benötigt der  xref:datasource_programs#specialagents[Spezialagent] für VMware ESXi (auch NetApp und viele weitere) die Öffnung des Ports 443 auf dem ESXi Server.
// MA: Gehört das didaktisch vor oder nach der Tabelle in das Kapitel rein?

[#cmk_incoming_host_outgoing]
=== Eingehende Ports auf dem {CMK}-Server (erreichbar durch überwachte Hosts)
// MA: Gleiche Fragen, wie oben in Kapitel 2.1.

Die folgenden Ports auf dem {CMK}-Server, beziehungsweise den Remote-Instanzen müssen für die Hosts im Monitoring erreichbar sein, wenn volle Funktionalität gewünscht ist.
// MA: Was ist denn eine volle Funktionalität? Reicht es, wenn das in der Tabelle geklärt wird?

[cols="10,10,~,~",options="header"]
|===
|Port |Protokoll |Bezeichnung |ergänzende Informationen
|80 |TCP |HTTP (Hypertext Transfer Protocol) |Agent Updater (xref:wato_monitoringagents#bakery[Agentenbäckerei])
|162 |UDP |Simple Network Management Protocol Trap (SNMPTRAP) EC |Empfang von xref:ec#snmp[SNMP-Traps (Event Console)] _(optional aktivierbar)_
|443 |TCP |HTTPS (Hypertext Transfer Protocol over SSL/TLS) |Agent Updater (xref:wato_monitoringagents#bakery[Agentenbäckerei]), unverschlüsselte Alternative Port 80
// MA: Der Witz von 443 ist, dass es verschlüsselt ist, oder?
|514 |TCP und UDP |xref:ec#syslogfacility[Syslog (EC)] |Empfang von Syslog-Nachrichten (Event Console) _(optional aktivierbar)_
|6559 |UDP | link:https://checkmk.com/werk/8350[Echtzeitprüfungen^] | Empfang von UDP-Paketen für die Echtzeitprüfungen einzelner Dienste (selten verwendet) _(optional aktivierbar)_
|8000 |TCP |Agent Controller TLS-Registrierung |Wenn mehrere Instanzen auf einem Host laufen, sind eventuell weitere Ports (8001, 8002…) nötig
|===

Die TLS-Registrierung von Agenten nutzt zudem das REST-API auf Port 80/443 zur Discovery des Registrierungs-Ports (meist TCP 8000).
Sind diese nicht erreichbar, kann der Port per xref:agent_linux#networkrequirements[Kommandozeilenoption] angegeben werden.
// MA: Gehört das nicht eher in die Tabelle?

== Ports im verteilten Monitoring
// MA: Warum unterscheiden wir überhaupt diese beiden Fälle? => "reguläres Monitoring" vs. "verteiltes Monitoring". Ist verteiltes Monitoring dann irreguläres Monitoring? Oder sind Ports aus dem verteilten Monitoring nicht eher Spezialfälle vom regulären Monitoring?

[#remote_incoming_cmk_outgoing]
=== Eingehende Ports auf Remote-Instanzen (erreichbar durch den {CMK}-Server)
// MA: Durch welchen Checkmk-Server? Eine Remote-Instanz ist doch auch ein Checkmk-Server?

Die folgenden Ports auf Remote-Instanzen müssen durch den als Zentralinstanz arbeitenden {CMK}-Server erreichbar sein.
// MA: Jetzt wirds klar. Der Titel wirft aber eher Fragen auf.

[cols="10,10,~,~",options="header"]
|===
|Port |Protokoll|Bezeichnung |ergänzende Informationen
|80 |TCP |HTTPS (Hypertext Transfer Protocol) |Synchronisierung im xref:glossar#distributed_monitoring[verteilten Monitoring]
|443 |TCP |HTTPS (Hypertext Transfer Protocol over SSL/TLS) |Synchronisierung im verteilten Monitoring, unverschlüsselte Alternative Port 80
// MA: Auch hier wieder: 443 verschüsselt und 80 ist unverschlüsselt.
|6555 |TCP | Notification Spooler | Der xref:distributed_monitoring#notifications[Notification Spooler] dient dem zentralen Versand von Benachrichtigungen (bei Verbindungsaufbau durch die Zentralinstanz) _(optional aktivierbar)_
|6557 |TCP |xref:livestatus#[Livestatus] |Wenn mehrere Instanzen auf einem Host laufen, sind eventuell weitere Ports nötig _(optional aktivierbar)_
|6558 |TCP | |Statusanschluss der Event Console _(optional aktivierbar)_
// MA: Irgendwie wird nicht so richtig klar, dass Port 6557, 6558, 6559, etc. eigentlich nur defaults von uns sind. Das sind keine standardisierten Ports. Man kann auch 34555, 12345 oder 9256 nehmen.
|===

[#cmk_incoming_remote_outgoing]
=== Eingehende Ports auf dem {CMK}-Server (erreichbar durch Remote-Instanz)
// MA: Irgendwie undurchsichtig. Ich glaube, man erkennt nur, was mit "Checkmk-Server" gemeint ist, wenn man die vorherigen Kapitel gelesen hat.

Die folgenden Ports auf dem {CMK}-Server müssen durch die zugeordneten Remote-Instanzen erreichbar sein, wenn der volle Funktionsumfang des verteilten Monitorings genutzt werden soll.
// MA: Auch hier wieder: Was ist denn ein voller Funktionsumfang?

[cols="10,10,~,~",options="header"]
|===
|Port |Protokoll |Bezeichnung |ergänzende Informationen
|80 |TCP |HTTP (Hypertext Transfer Protocol) |Für xref:wato_monitoringagents#bakery[Agentenbäckerei] und xref:dcd#[dynamische Host-Konfiguration]
|443 |TCP |HTTPS (Hypertext Transfer Protocol over SSL/TLS) |Für xref:wato_monitoringagents#bakery[Agentenbäckerei] und xref:dcd#[dynamische Host-Konfiguration], unverschlüsselte Alternative Port 80
|6555 |TCP | Notification Spooler | Der xref:distributed_monitoring#notifications[Notification Spooler] dient dem zentralen Versand von Benachrichtigungen (bei Verbindungsaufbau durch die Remote-Instanz) _(optional aktivierbar)_
|===

Prinzipiell ist verteiltes Monitoring ohne weitere Hilfsmittel wie Tunneling bereits möglich, wenn die Zentralinstanz eine Verbindung zu den Remote-Instanzen herstellen kann. Die Erreichbarkeit der Zentralinstanz durch Remote-Instanzen ist nur für optionale Funktionalitäten (z.B. Agent Bakery) erforderlich.
// MA: Aaah. Sehr interessant. Aber sollte die Information nicht kommen, bevor ich mir alle notwendigen Ports anschauen (und ggf. freischalte)? Das ist ja scheinbar der volle Funktionsumfang, von dem am Anfang des Kapitels gesprochen wird.

[#loopback]
== Lokale Ports auf dem {CMK}-Server
// MA: Weshalb muss ich die beachten?

Die folgenden Ports werden vom {CMK}-Server (respektive den Remote-Instanzen) lokal genutzt.
// MA: Was heißt denn "lokal genutzt"? Muss ich da etwas freischalten? Wenn ja: Wo?

[cols="10,10,~,~",options="header"]
|===
|Port |Protokoll |Bezeichnung |ergänzende Informationen
|5000 |TCP | HTTP Site Apache |Jede {CMK}-Site verfügt über einen eigenen Apache, auf den der extern aufrufbare Apache als Reverse Proxy zugreift, weitere Sites verwenden Port 5001 usw.
|6558 |TCP | |Statusanschluss der Event Console _(optional aktivierbar)_
// MA: Sicher, dass hier ein TCP-Port genutzt wird und nicht ein Unix-Socket? In welchen Fällen wird der TCP-Port genutzt und welchen Vor-/Nachteil hat das für mich?
|===

[#appliance_cluster]
== Am {CMK} Appliance Cluster benötigte Ports
// MA: Sollte der Abschnitt nicht zu den Artikeln der Appliance?

// These two sentences are copied from appliance_usage.asciidoc – 
// when translating you might copy and paste from there as well
Sie können zwei Checkmk-Appliances ("Knoten") zu einem xref:appliance_usage#_failover_cluster[Failover-Cluster] zusammenschließen.
Dabei werden alle Konfigurationen und Daten zwischen den beiden Geräten abgeglichen.

Die folgenden Ports müssen von beiden Knoten aus ein- und ausgehend freigegeben sein.

[cols="10,10,~,~",options="header"]
|===
|Port |Protokoll |Bezeichnung |ergänzende Informationen
|80 |TCP |HTTP (Hypertext Transfer Protocol) |für den Webconf-Zugang
|443 |TCP |HTTPS (Hypertext Transfer Protocol over SSL/TLS) |für den Webconf-Zugang, unverschlüsselte Alternative Port 80
// MA: Verschlüsselte Alternative.
|3121 |TCP |Pacemaker |für Pacemaker
|4321 |UDP |Corosync |für Corosync
|4323 |UDP |Corosync |für Corosync
|7789 |TCP |DRBD |für die DRBD Synchronisierung an den synchronisierenden Netzwerkschnittstellen
|===

[#misc_ports]
== Weitere Ports
// MA: Oben wird immer von eingehenden Ports gesprochen und der Leser/die Leserin wird dann ggf. nach ausgehenden Ports suchen. Aber man findet es nicht, weil es unter "weitere Ports" gelistet wird.

Eventuell benötigen Sie, vom {CMK}-Server ausgehend, einige weitere Ports:
// MA: Eigentlich braucht man doch nur Zugang zu anderen Servern und deren eingehenden Ports, oder? Also z.B. dem Port 53 UDP des Nameservers. Ausgehend von der Perspektive, die ketzerische Frage: Sprechen wir dann nicht immer von eingehenden Ports?

* SMTP zur Versendung von Benachrichtigungen vom {CMK}-Server über Mail (je nach Konfiguration des Mailservers Port 25, 465 oder 587 TCP)
* NTP Zeitsynchronisation (Port 123 UDP)
* DNS (Port 53 UDP)
* LDAP Authentifizierung (LDAP (Port 389 TCP) oder LDAPS (Port 636 TCP))

// MA: Wenn wir von eingehenden und ausgehenden Ports sprechen wollen, müssen wir eher die Sicht der Firewall einnehmen. Dann ist die Relation aber eine anderen und es geht eher darum, wer mit wem über welche Ports spricht. Eine Grafik ist da eigentlich sehr plastisch und erlaubt es sich besser vorzustellen, wer mit wem und warum über welchen Port spricht.