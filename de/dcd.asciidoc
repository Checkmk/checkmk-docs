// -*- coding: utf-8 -*-
include::global_attr.adoc[]
= Dynamische Hostkonfiguration
:revdate: draft
:title: Dynamische Hostkonfiguration - √úberwachen von dynamischen Infrastrukturen
:description: {CMK} kann fl√ºchtige Infrastrukturen durch dynamisches Hinzuf√ºgen und L√∂schen von Hosts in einem vollautomatischen Verfahren verwalten.

{related-start}
link:piggyback.html[Der Piggyback-Mechanismus]
link:monitoring_aws.html[Amazon Web Services (AWS) √ºberwachen]
link:monitoring_azure.html[Microsoft Azure √ºberwachen]
link:monitoring_kubernetes.html[Kubernetes √ºberwachen]
link:monitoring_docker.html[Docker √ºberwachen]
link:monitoring_vmware.html[VMWare ESXi √ºberwachen]
{related-end}

// include::include_disclaimer_20gui.asciidoc[]

== Einleitung

[{image-left}]
image::icon_dcd_connections.png[width=100%]

// MFS: Lassen wir "entstehen und vergehen" drin, oder? Auch wenn es etwas schw√ºltig klingt.
In Cloud- und Containerumgebungen ist es immer √∂fter der Fall, dass zu √ºberwachende
Hosts automatisch entstehen und vergehen. Die Konfiguration des Monitorings hier
aktuell zu halten, ist manuell nicht mehr sinnvoll m√∂glich. Aber auch klassische
Infrastrukturen wie z.B. VMware-Cluster k√∂nnen sehr dynamisch sein, und selbst wenn
eine manuelle Pflege hier noch m√∂glich ist, ist sie doch auf jeden Fall l√§stig.

// Ab Version {v16} der {CEE} unterst√ºtzt Sie {CMK} bei diesem
Die {CEE} von {CMK} unterst√ºtzt Sie bei diesem
Thema mit einem smarten Werkzeug: dem _Dynamic Configuration Daemon_
oder kurz _DCD_. Die dynamische Konfiguration von Hosts bedeutet, dass
aufgrund von Informationen aus der √úberwachung von link:monitoring_aws.html[AWS],
link:monitoring_azure.html[Azure], link:monitoring_kubernetes.html[Kubernetes],
link:monitoring_vmware.html[VMware] und anderen Quellen vollautomatisch Hosts in das
Monitoring aufgenommen, aber auch wieder entfernt werden k√∂nnen.

Der DCD ist dabei sehr generisch gehalten und nicht auf das Anlegen von Hosts
beschr√§nkt. Er bildet die Grundlage f√ºr k√ºnftige Erweiterungen von {CMK},
welche dynamisch die Konfiguration anpassen. Das kann z.B. auch
das Verwalten von Benutzern bedeuten. Zu diesem Zweck arbeitet der DCD
mit sogenannten _Konnektoren_. Jeder Konnektor kann aus einer ganz
bestimmten Art von Quelle Informationen holen und hat dazu seine eigene
spezifische Konfiguration.

Mit speziellen Konnektoren wird es in Zukunft noch einfacher werden,
Hosts aus einer vorhandenen CMDB automatisch nach {CMK} zu √ºbernehmen.


== Verwalten von Hosts mit dem DCD

=== Der Piggyback-Konnektor

Derzeit ist der DCD von {CMK}
nur mit einem einzigen Konnektor ausgestattet: demjenigen f√ºr
link:piggyback.html[Piggyback-Daten]. Dieser ist jedoch sehr universell, denn der
Piggyback-Mechanismus wird von {CMK} in allen Situationen verwendet, wo die
Abfrage von einem Host (meist per Spezialagent) Daten zu anderen Hosts liefert
(meist virtuelle Maschinen oder Cloudobjekte).

Hier sind einige Beispiele,
wo {CMK} bei der √úberwachung Piggyback einsetzt:

* link:monitoring_aws.html[AWS]
* link:monitoring_azure.html[Azure]
* link:monitoring_kubernetes.html[Kubernetes]
* link:monitoring_docker.html[Docker]
* link:monitoring_vmware.html[VMware]

In allen diesen F√§llen werden beim Monitoring automatisch Daten zu anderen
Hosts (z.B. den VMs) geholt, die nicht direkt per Netzwerk angesprochen werden und auf
denen auch kein {CMK}-Agent laufen muss. Mit dem DCD k√∂nnen Sie solche Hosts
automatisch ins Monitoring aufnehmen und auch wieder entfernen lassen, um so immer
zeitnah die Realit√§t abzubilden.

Dazu analysiert der DCD die vorhandenen Piggyback-Daten, vergleicht, welche
der Hosts bereits im Setup vorhanden sind und legt die fehlenden Hosts neu
an bzw. entfernt inzwischen weggefallene.  Dabei sind Hosts, welche vom DCD
automatisch angelegt wurden, trotzdem f√ºr Sie in der Setup-GUI editierbar.


=== Dynamische Konfiguration einrichten

==== Sind Piggyback-Daten da?

Als einzige Voraussetzung, um den DCD zu nutzen, ben√∂tigen Sie
Piggyback-Daten. Diese haben Sie immer dann, wenn Sie das Monitoring f√ºr AWS,
Azure und Co. korrekt aufgesetzt haben. Sie k√∂nnen das auch leicht auf der
Kommandozeile √ºberpr√ºfen, denn die Piggyback-Daten werden von {CMK} im Verzeichnis `tmp/check_mk/piggyback`
angelegt:

[{shell}]
----
{c-omd} ls tmp/check_mk/piggyback
myvm01  myvm02  myvm03
----

Wenn dieses Verzeichnis nicht leer ist, dann wurden in dieser Instanz Piggyback-Daten erzeugt.

==== Generelle Einstellungen eines Konnektors

Gehen Sie nun in die Hostverwaltung ser Setup-GUI.
Der Men√ºpunkt [.guihint]#Setup > Hosts > Dynamic host configuration bringt Sie zur Konfiguration
des DCD beziehungsweise dessen Konnektoren:

// [{image-border}]
image::dcd_connections_empty.png["Screenshot:  Leere Konnektorenliste in der Dynamic host configuration"]

Legen Sie mit icon:icon_new[] [.guihint]#Add connection# eine neue Verbindung an.
Der erste Teil der Konfiguration sind die [.guihint]#General properties#:

image::dcd_connection_general.png["Screenhsot: General properties beim Hinzuf√ºgen einer neuen Connection"]

Hier vergeben Sie, wie so oft, eine eindeutige ID dieser Verbindung und
einen Titel. Wichtig ist ferner die Auswahl der {CMK}-Instanz, auf der dieser
Konnektor laufen soll. Da Piggyback-Daten immer nur lokal verarbeitet werden
k√∂nnen, muss der Konnektor immer einer konkreten Instanz zugeordnet werden.

==== Eigenschaften des Konnektors

Der zweite Teil sind die [.guihint]#Connection properties#:

image::dcd_connection_properties.png["Screenshot: Einstellungen des Konnektors im Detail"]

Hier ist bereits der Konnektor [.guihint]#Piggyback data# vorausgew√§hlt
(und aktuell auch der einzig m√∂gliche).

Mit dem [.guihint]#Sync interval# bestimmen Sie, wie oft der Konnektor nach neuen Hosts suchen
soll. Wenn Sie das regul√§ren Checkintervall von einer Minute beibehalten haben, macht es
keinen Sinn, das wesentlich √∂fter zu machen, da ja maximal einmal pro Minute eine √Ñnderung
der Piggyback-Daten stattfinden kann. In h√∂her dynamischen Umgebungen k√∂nnen Sie sowohl
Checkinterval als auch das Konnektorintervall auch auch deutlich kleinere Werte einstellen.
Dies hat allerdings auch eine h√∂here CPU-Auslastung auf dem {CMK}-Server zur Folge.

Wichtig ist jetzt, dass Sie mindestens eine [.guihint]#Piggyback creation option# hinzuf√ºgen ([.guihint]#Add new element#).

image::dcd_connection_properties_2.png["Screenshot: Ordner, in dem Hosts erstellt werden und Datenquellen, die hierf√ºr herangezogen werden"]

Hier k√∂nnen Sie zwei wichtige Dinge festlegen: In welchem Ordner die Hosts erzeugt werden sollen (hier z.B. [.guihint]#AWS Cloud 02#)
und welche Hostattribute gesetzt werden sollen. Vier wichtige Attriute sind dabei voreingestellt, welche f√ºr Piggyhosts
meistens Sinn ergeben:

. Kein Monitoring per SNMP
. Kein {CMK}-Agent auf dem Host selbst (Daten kommen ja per Piggyback)
. Dass Piggyback-Daten immer erwartet werden (und es einen Fehler gibt, wenn diese fehlen)
. Und dass die Hosts keine IP-Adresse haben

*Wichtig:* Nur wenn Sie [.guihint]#Delete vanished hosts# aktivieren, werden Hosts auch
wieder entfernt, wenn Sie in Ihrer dynamischen Umgebung verschwunden sind.

M√∂chten Sie nicht automatisch alle Hosts anlegen,
so k√∂nnen Sie das mit der Option [.guihint]#Only add matching hosts# mit einem link:regexes.html[regul√§ren Ausdruck]
einschr√§nken. Wichtig: gemeint sind hier die Hosts, welche _angelegt_ werden und _nicht_
die Hosts, √ºber den Sie die √úberwachung von z.B. AWS eingerichtet haben.

Letzteres k√∂nnen Sie mit der Option [.guihint]#Restrict source hosts# erreichen. Diese
bezieht sich auf die Namen der Hosts, welche Piggyback-Daten _erzeugen_.


==== Activate Changes

Zwei weitere Optionen befassen sich mit dem automatischen Aktivieren von
√Ñnderungen -- f√ºr den Fall, dass wirklich Hosts angelegt oder entfernt
wurden. Denn nur dadurch tauchen diese dann auch im operativen Monitoring auf.

Wenn das [.guihint]#Activate changes# bei Ihrer Installation sehr lange dauert, k√∂nnen Sie mit
[.guihint]#Group "Activate changes"# daf√ºr sorgen, dass das nach M√∂glichkeit nicht sofort bei jedem neuen
Host sofort passiert, sondern man etwas ‚Äûzusammenkommen l√§sst‚Äú.

Ferner k√∂nnen Sie das automatische Aktivieren von √Ñnderungen auch f√ºr bestimmte Tageszeiten
komplett verbieten -- z.B. f√ºr die Tageszeiten, wo ihr Monitoringsystem aktiv betreut wird.
Denn wenn der DCD √Ñnderungen aktiviert, werden auch alle anderen √Ñnderungen aktiv, die Sie
oder ein Kollege gerade gemacht haben!

Nachdem Sie gespeichert haben, erscheint der Konnektor in der Liste. Er kann aber
noch nicht ausgef√ºhrt werden, bevor Sie ein [.guihint]#Activate Changes# durchgef√ºhrt haben.
Erst dadurch nimmt er seinen Dienst auf. Lassen Sie sich daher nicht von der Meldung
[.guihint]#Failed to get the status from DCD (The connection 'piggy01' does not exist)#,
irritieren, welche zun√§chst nach dem Speichern erscheint.

== Den Konnektor in Betrieb nehmen

=== Erstes Aktivieren

Nach dem Speichern der Konnektoreigenschaften und einem [.guihint]#Activate Changes# nimmt die
Verbindung automatisch ihren Betrieb auf. Das kann so schnell gehen, dass Sie bereits
direkt nach dem Aktivieren der √Ñnderungen sofort sehen, wie Hosts im Monitoring angelegt wurden:

image::dcd_pending_changes.png["Screenshot: Liste der Pending changes unmittelbar vor der automatischen √úbernahme ins Monitoring""]

Wenn Sie diese Seite kurz darauf neu laden, sind diese √Ñnderungen wahrscheinlich schon
wieder verschwunden, weil sie ja vom DCD automatisch aktiviert wurden. Die neuen Hosts
sind dann bereits im Monitoring und werden regelm√§√üig √ºberwacht.


== Automatisches L√∂schen von Hosts

=== Wann werden Hosts entfernt?

Wie oben erw√§hnt, k√∂nnen Sie den DCD selbstverst√§ndlich Hosts, die es
‚Äûnicht mehr gibt‚Äú automatisch aus dem Monitoring l√∂schen lassen. Das klingt erstmal
sehr logisch. Was _genau_ das ‚Äûnicht mehr gibt‚Äú allerdings bedeutet,
auf den zweiten Blick doch etwas komplexer, da es verschiedene F√§lle zu
betrachten gibt. Wir gehen in folgender √úbersicht davon aus, dass Sie
die L√∂schoption aktiviert haben. Denn sonst werden grunds√§tzlich nie
Hosts automatisch entfernt.

[cols="30,~"]
|===
|Situation |Was geschieht? 

|Entfernen eines DCD-Konnektors |Wenn Sie eine DCD-Verbindung stilllegen ([.guihint]#do not activate this dynamic configuration connection#) oder ganz entfernen, bleiben alle Hosts, die durch diese Verbindung erzeugt wurden, erhalten. Bei Bedarf m√ºssen Sie diese von Hand l√∂schen.
|Piggyback-Host wird nicht mehr √ºberwacht |Wenn Sie den Host, √ºber den Sie Ihre Cloud- oder Containerumgebung √ºberwachen, aus dem Monitoring entfernen, erzeugt dieser nat√ºrlich keine Piggyback-Daten mehr. In diesem Fall werden die automatisch erzeugten Hosts _nach einer Stunde_ automatisch entfernt.
|Piggyback-Host ist nicht erreichbar |Wenn Ihre Cloudumgebung mal nicht erreichbar und der {CMK}-Service, der diese abfragt, auf {CRIT} geht, so bleiben die erzeugten Hosts _auf unbestimmte Zeit_ im Monitoring. Hier gibt es keinen einst√ºndigen Timeout!
|Der {CMK}-Server selbst ist gestoppt |Ein Stoppen des ganzen Monitorings f√ºhrt zwar dazu, dass Piggyback-Daten veralten. Aber nat√ºrlich werden angelegte Hosts deswegen _nicht_ gel√∂scht. Das gleiche gilt, wenn der {CMK}-Server neu gebootet wird (wodurch vor√ºbergehend alle Piggyback-Daten verloren gehen, da diese in der RAM-Disk liegen).
|Ein Host ist nicht mehr in den Piggyback-Daten enthalten |Das ist quasi der Normalfall: Ein Host in der Cloud-/Containerumgebung ist verschwunden. In diesem Fall wird er _sofort_ aus dem Monitoring entfernt.
|===


=== Konfigurationsm√∂glichkeiten

Neben der Frage, ob Hosts √ºberhaupt automatisch entfernt werden sollen, gibt es bei den Konnektoreneigenschaften
noch drei weitere Optionen, die das L√∂schen beeinflussen und die wir vorhin √ºbersprungen haben:

image::dcd_deletion_tuning.png["Screenshot: Feineinstellungen zum automatischen L√∂schen von Hosts"]

Die erste Einstellung -- [.guihint]#Prevent host deletion right after initialization# -- betrifft einen
kompletten Neustarts des {CMK}-Servers selbst. Denn in dieser Situation fehlen erstmal Piggyback-Daten
von allen Hosts, bis diese zum ersten Mal abgefragt wurden. Um ein sinnloses L√∂schen und Wiedererscheinen von
Hosts zu vermeiden (welches auch mit wiederholten Alarmen zu schon bekannten Problemen einhergeht), wird
per Default in den ersten 10 Minuten auf ein L√∂schen generell verzichtet. Diese Zeit k√∂nnen Sie hier
einstellen.

Die Option [.guihint]#Validity of missing data# behandelt den
Fall, dass ein Host, aufgrund dessen Monitoring-Daten etliche Hosts automatisch angelegt wurden,
keine Piggyback-Daten mehr liefert. Das kann z.B. der Fall sein, wenn ein Zugriff
auf AWS und Co. nicht mehr funktioniert. Oder nat√ºrlich auch, wenn Sie den Spezialagenten aus der
Konfiguration entfernt haben. Die automatisch erzeugten Hosts bleiben dann noch die eingestellte
Zeit im System, bevor sie aus dem Setup-GUI entfernt werden.

Die Option [.guihint]#Validity of outdated data# ist
√§hnlich, behandelt aber den Fall, dass schon noch Piggyback-Daten kommen, allerdings f√ºr manche Hosts
nicht mehr. Das ist der normale Fall wenn z.B. virtuelle Maschinen oder Clouddienste nicht mehr
vorhanden sind. Wenn Sie m√∂chten, dass die entsprechenden Objekte aus {CMK} dann zeitnah verschwinden,
dann setzen Sie hier eine entsprechend kurze Zeitspanne.

== Diagnose

=== Ausf√ºhrungshistorie

Wenn Sie dem DCD bei der Arbeit zusehen m√∂chten, finden Sie in der Liste der Konnektoren bei jedem Eintrag
das Symbol icon:icon_dcd_history[]. Dieses f√ºhrt Sie zur Ausf√ºhrungshistorie:

image::dcd_execution_history.png["Screenshot: Ausf√ºhrungshistorie bei Suche und Anlegen neuer Hosts"]

// MFS: Das ist nicht mehr korrekt, Klammern oder üï± werden einfach gestrippt. Muss man leider schwammiger formulieren. :-/
////
Im abgebildeten Beispiel sehen Sie einen Fehler, der beim Erzeugen der Konfiguration auftritt: Der
Host mit dem Namen `Guest_Introspection_(4)` konnte nicht angelegt werden, weil durch die
runden Klammern im Namen sich kein f√ºr {CMK} g√ºltiger Hostname ergibt.
////

Sollte aus irgendwelchen Gr√ºnden die Erstellung eines Hosts fehlschlagen, sehen Sie dies in der Ausf√ºhrungshistorie.

=== Das Auditlog der Setup-GUI

Wenn Sie in der Setup-GUI auf der Seite sind, wo Sie √Ñnderungen aktivieren k√∂nnen, finden Sie dort einen
Knopf mit dem Namen [.guihint]#Audit Log#. Dieser bringt Sie zu einer Liste aller √Ñnderungen, die in
der Setup-GUI gemacht wurden -- egal ob diese bereits aktiviert wurden oder nicht. Suchen Sie nach
Eintr√§ge vom Benutzer `automation`. Unter diesem Account arbeitet der DCD und erzeugt
√Ñnderungen. So k√∂nnen Sie nachvollziehen, wann er welchen Host angelegt oder entfernthat.

=== Die Logdatei des DCD

Die Logdatei des DCD finden Sie auf der Kommandozeile in der Datei `var/log/dcd.log`.
Hier ist ein Beispiel, welches zu obiger Abbilung passt. Auch hier finden Sie die Fehlermeldung,
dass ein bestimmter Host nicht angelegt werden konnte:

.var/log/dcd.log
[{file}]
----
2021-11-10 14:45:22,916 [20] [cmk.dcd] ---------------------------------------------------
2021-11-10 14:45:22,916 [20] [cmk.dcd] Dynamic Configuration Daemon (2.0.0p14) starting (Site: mysite, PID: 7450)...
2021-11-10 14:45:22,917 [20] [cmk.dcd.ConnectionManager] Initializing 0 connections
2021-11-10 14:45:22,918 [20] [cmk.dcd.ConnectionManager] Initialized all connections
2021-11-10 14:45:22,943 [20] [cmk.dcd.CommandManager] Starting up
2021-11-10 15:10:58,271 [20] [cmk.dcd.Manager] Reloading configuration
2021-11-10 15:10:58,272 [20] [cmk.dcd.ConnectionManager] Initializing 1 connections
2021-11-10 15:10:58,272 [20] [cmk.dcd.ConnectionManager] Initializing connection 'piggy01'
2021-11-10 15:10:58,272 [20] [cmk.dcd.ConnectionManager] Initialized all connections
2021-11-10 15:10:58,272 [20] [cmk.dcd.ConnectionManager] Starting new connections
2021-11-10 15:10:58,272 [20] [cmk.dcd.piggy01] Starting up
2021-11-10 15:10:58,273 [20] [cmk.dcd.ConnectionManager] Started all connections
2021-11-10 15:10:58,768 [40] [cmk.dcd.piggy01] Creation of "Guest_Introspection_(4)" failed: Please enter a valid hostname or IPv4 address. Only letters, digits, dash, underscore and dot are allowed.
----


[#files]
== Dateien und Verzeichnisse

[cols="30,~"]
|===
|Pfad |Bedeutung 

|tmp/check_mk/piggyback |Hier entstehen Piggyback-Daten. F√ºr jeden in den Piggyback-Daten enthaltenen Zielhost entsteht ein Verzeichnis.
|var/log/dcd.log |Logdatei des Dynamic Configuration Daemon (DCD)
|===


