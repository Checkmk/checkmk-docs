// -*- coding: utf-8 -*-
include::global_attr.adoc[]
= Lizenzen verwalten
:revdate: draft
:title: Lizenzen verwalten - Lizenzinformationen sammeln und übermitteln
:description: Hiermit sammeln Sie in {CMK} transparente Information über den aktuellen Lizenzstatus und können diese vollautomatisch übermitteln.
// TK: description aktualisieren, etwa so:
// Wie Sie in {CMK} Informationen zur Lizenznutzung und zur Lizensierung der sammeln und übermitteln, erfahren Sie in diesem Artikel.

// TK: Allgemein: bitte hab ich eliminiert.


==  Einleitung

{cee-only} Nutzen Sie die {CSE} oder die {CCE} (oberhalb der Grenzen des Lizenzstatus „Free“), so sind Sie verpflichtet, regelmäßig eine Übersicht über den Einsatz von {CMK} in Ihrem Unternehmen an die {comfull} zu liefern.
// TK: Vielleicht doch zur Klarstellung: oberhalb der Grenzen des Lizenzstatus „Free“: maximal 750 Services in einer Instanz
// TK: Die CME fehlt hier. Absicht?
// TK: Free und Trial zusammen mit Lizenzstatus sollen in Anführungszeichen. Ich habs geändert.
Nach der Ersteinrichtung - und im Falle der {CE} der Lizenzeinspielung zum Ende der Testphase (Lizenzstatus „Trial“) - kann {CMK} Ihnen den Rest dieser Verwaltungsarbeit komplett abnehmen.

{CMK} sammelt jeden Tag zu einem zufälligen Zeitpunkt die aktuellen Service-Zahlen für alle verbundenen {CMK}-Instanzen.
Diese werden in der Lizenznutzung übersichtlich und transparent dargestellt.

{CMK} speichert diese Informationen über einen Zeitraum von 400 Tagen. Ältere Daten werden entfernt.

Als Administrator von {CMK} überlassen Sie die Kommunikation mit dem {CMK}-Kundenportal komplett {CMK}, sowohl für die Lizenzierung als auch für die Übermittlung der Nutzungsinformationen.
Sollte Ihnen dies technisch nicht möglich sein, so können Sie die Kommunikation alternativ manuell ausführen.


[#generate_application_password]
== Subskriptionsdaten aus dem Kundenportal auslesen

Rufen Sie das link:https://portal.checkmk.com/de/[{CMK}-Kundenportal^] auf.
Melden Sie sich dort mit Ihren Zugangsdaten an, um die [.guihint]#Licensing Credentials# zu erstellen, die Sie im nächsten Schritt in {CMK} eintragen müssen.

Wählen Sie Ihre Subskription aus.
Die Ansicht sieht dann beispielsweise so aus:

image::license_subscription.png[alt="Die License Subscription im Kundenportal."]

Hinweis: Sollten Sie die markierten Knöpfe nicht sehen, so hat Ihr Benutzerkonto möglicherweise keine passenden Rechte im {CMK}-Kundenportal.
Wenden Sie sich in so einem Fall an den in Ihrem Unternehmen für die Lizenzverlängerung zuständigen Administrator.

Klicken Sie nun auf [.guihint]#Generate Licensing Credentials#, um das Passwort für die Übermittlung zu erstellen.

image::license_generate_password.png[alt="Passwort im Kundenportal erstellen.", width=78%]

Kopieren Sie die [.guihint]#Licensing ID# und das [.guihint]#Password# und schließen Sie dieses Fenster mit [.guihint]#Confirm#.


[#license_cce]
== Lizenzierung der {CE}

Nach Ablauf der Testphase müssen Sie, zu Beginn der ersten Lizenzphase, eine Verifizierungsanfrage an das link:https://portal.checkmk.com/de/[{CMK}-Kundenportal^] übertragen und sich einen passenden Lizenzschlüssel geben lassen.
Diesen laden Sie in {CMK} hoch, um Ihre {CE} zu lizenzieren und zur weiteren Nutzung freizuschalten.
// TK: Das klingt danach, als ob ich aktiv den Lizenzschlüssel hochladen muss. Das passiert aber automatisch, oder?

*Hinweis:* Mit dem Kauf einer {CMK}-Edition haben Sie die Zugangsdaten für das {CMK}-Kundenportal erhalten.
Sollten Sie diese nicht (mehr) haben, so kontaktieren Sie bitte link:https://checkmk.com/de/kontakt[{CMK}-Sales^].
// TK: den {CMK}-Vertrieb? So heisst es auf der deutschen Web-Seite (Link hab ich geändert)
// TK: Der Hinweis zum Kundenportal gehört ins vorherige Kapitel. Dann passt auch der Anschluss zum nächsten Absatz: Dies gilt natürlich nur...

Dies gilt natürlich nur, wenn Sie die Grenzwerte des Lizenzstatus „Free“ überschritten haben.
Anderenfalls können Sie Ihre {CE} im Lizenzstatus „Free“ ungehindert weiter nutzen ohne eine Lizenzierung durchführen zu müssen.


[#setup_cce]
=== Subskriptionsdaten in {CMK} eingeben

Öffnen Sie als xref:wato_user#roles[{CMK}-Administrator] [.guihint]#Setup > Maintenance > Licensing.#
Die Seite ist noch leer, solange keine Subskriptionsdaten hinterlegt wurden.

image::license_licensing_ce_ausschnitt.png[alt="Der Knopf 'Edit settings' zum Öffnen der Seite mit den Subskriptionseinstellungen."]

Öffnen Sie mit dem Knopf [.guihint]#Edit settings# die gleichnamige Seite:

image::license_edit_settings_ce.png[alt="Formular zur Eingabe der Lizenznutzungseinstellungen."]

Wählen Sie nun, ob Sie die Subskriptionsinformationen online oder offline übermitteln wollen.
Wir empfehlen, die Online-Übermittlung zu nutzen. Dann kann Ihnen {CMK} alle weiteren Aktivitäten zur Lizenzierung abnehmen.
Für die Online-Übermittlung füllen Sie noch die Felder [.guihint]#Licensing ID# und [.guihint]#Password# mit den xref:generate_application_password[Informationen aus dem Kundenportal.]

Zum Abschluss klicken Sie auf [.guihint]#Save#, um Ihre Angaben zu speichern.


=== Lizenznutzungsinformationen an die {comfull} übermitteln

Als Benutzer der {CE} lassen Sie {CMK} alle Arbeiten zur Übermittlung Ihrer Lizenzinformationen übernehmen.
Nur falls in Ihrem Unternehmen der {CMK}-Server aus technischen Gründen das {CMK}-Kundenportal nicht erreichen kann, müssen Sie xref:manualtrans[die Daten manuell übermitteln].
// TK: {com} nur verwenden, wenn explizit die GmbH gemeint ist, sonst {CMK}. Das Kundenportal hiess auch vor der Umbenennung {CMK}-Kundenportal.
Ihre Lizenzinformationen sind für Sie jederzeit transparent einsehbar.
Es werden die Angaben verwendet, die Sie auf den Seiten [.guihint]#License usage# und [guihint]#Edit settings# sehen.


[#directtrans]
==== Direktübermittlung durch {CMK}
// TK: Warum hier ein Unterkapitel? Würde ich auflösen (gilt analog für das Unterkapitel unten). Du kannst oben den 1. Satz umformulieren:
// Als Benutzer der {CE} lassen Sie Ihrer Lizenzinformationen durch {CMK} per Online-Übermittlung übertragen.

Die [.guihint]#Licensing credentials# müssen vor der ersten Übertragung in {CMK} hinterlegt worden sein (siehe xref:setup_cce[Subskriptionsdaten in {CMK} eingeben]).

Haben Sie sich für die Online-Übermittlung entschieden (der entsprechende Knopf ist aktiv), so klicken Sie auf [.guihint]#Online verification#.
// TK: Schaltfläche steht auf dem Index > Knopf (ich habs geändert)
// TK: Das ist etwas umständlich formuliert: Der "entsprechende" Knopf ist aktiv, der gleich darauf beim Namen genannt wird.
Sie erhalten dann eine Erfolgsmeldung in {CMK}.

image::license_online_success_cce.png[alt="."]
// TK: Im Screenshot fehlt leider die Aktionsleiste mit dem Button Online verification. Daher weiß ich nicht so genau, wo ich hinklicken soll... 
// TK: Schöner Alt-Text ;-)

Damit haben Sie Ihre {CE} erstmalig für die lizenzierte Nutzung freigeschaltet.

Ab jetzt meldet {CMK} regelmäßig Ihre aktuelle Lizenznutzung an die {comfull}. Nach jeder erfolgreichen Übertragung sehen Sie eine Bestätigung sowie eine Zusammenfassung der übermittelten Informationen. Im Rahmen dieses Prozesses holt {CMK} auch automatisch neue Lizenzinformationen aus dem {CMK}-Kundenportal, falls Sie zwischenzeitlich die Lizenz erweitert oder verlängert haben.

Sie können jederzeit eine erneute Synchronisation Ihrer Daten mit dem {CMK}-Kundenportal anstoßen, indem Sie den Button [.guihint]#Online verification# anklicken.


=== Lizenzkontrolle in der {CE}

//SP: Dieses Kapitel wurde auf Wunsch des Managements erstellt. Es sollte m.E. so schnell wie möglich wieder aus dem Handbuch entfernt werden. Dies ist kein Teil der technischen Anleitung.
// TK: Daher auch kein weiterer inhaltlicher Kommentar von mir zu diesem Kapitel.
Was passiert, wenn sich die Nutzungsphase Ihrer {CE}-Lizenz dem Ende nähert?
Hier greift eine Abfolge verschiedener Eskalationsstufen.
Sobald eine neue Lizenzierung hochgeladen wurde, wird das Eskalationssystem abgebrochen.
// TK: Lizenz statt Lizenzierung?

Überprüft wird hierbei nur die Laufzeit der Lizenz.
Gleichzeitig läuft Ihr Monitoring aber normal weiter, auch Benachrichtigungen werden regulär verschickt.
Jedoch wird die Möglichkeit Änderungen zu aktivieren im Falle einer Verletzung der vereinbarten Lizenzrichtlinien unterbunden.
Eine Überschreitung der aktuell lizenzierten Services und Module hingegen wird nur erfasst und mit der nächsten Abrechnung rückwirkend in Rechnung gestellt.

Derzeit gelten die folgenden Eskalationsstufen:

* 30 Tage vor Lizenzende verschickt {CMK} eine E-Mail an die Administratoren, um diese über den Ablauf des Lizenzzeitraums zu informieren. 
* 14 Tage vor Lizenzablauf verschickt {CMK} eine weitere E-Mail an die Administratoren. Zeitgleich wird für die Administratoren in {CMK} ein Hinweis-Banner sichtbar.
* 7 Tage vor Lizenzablauf verschickt {CMK} erneut eine E-Mail an die Administratoren. Außerdem wird nun in {CMK} für alle Benutzer dauerhaft ein Hinweis-Banner sichtbar.
* Nach Ablauf einer Karenzzeit blockiert {CMK}, wie oben beschrieben, die Möglichkeit Änderungen zu aktivieren. Das Hinweis-Banner bleibt für alle Benutzer dauerhaft sichtbar.

Sollte sich Ihr {CMK} in einem blockierten Zustand befinden, so kontaktieren Sie Ihren Ansprechpartner bei {CMK}-Sales.
// TK: siehe oben: {CMK}-Vertrieb?
Dieser kann Ihnen gerne weiterhelfen.
// TK: Gendern vermeiden, etwa so:
// Sollte sich Ihr {CMK} in einem blockierten Zustand befinden, so kontaktieren Sie den {CMK}-Vertrieb, der Ihnen weiterhelfen kann.


== Lizenzierung der {SE} und der {ME}

Wenn Sie mit einer {SE} oder einer {ME} starten, schalten Sie anfangs nur Ihre Lizenz frei.
Die Übermittlung der Nutzungsdaten startet erst zum Ende der ersten Lizenzphase.

[#setup_cee]
=== Subskriptionsdaten in {CMK} eingeben

Öffnen Sie als xref:wato_user#roles[{CMK}-Administrator] [.guihint]#Setup > Maintenance > Licensing.#
Die Seite ist noch leer, solange keine Subskriptionsdaten hinterlegt wurden.

image::license_licensing_ausschnitt.png[alt="Der Knopf 'Edit settings' zum Öffnen der Seite mit den Subskriptionseinstellungen."]

Öffnen Sie mit dem Knopf [.guihint]#Edit settings# die gleichnamige Seite:

image::license_edit_settings.png[alt="Formular zur Eingabe der Lizenznutzungseinstellungen."]

Wählen Sie nun, ob Sie die Subskriptionsinformationen online oder offline übermitteln wollen.
Wir empfehlen, die Online-Übermittlung zu nutzen.
Dann kann Ihnen {CMK} die Arbeit zur Übermittlung Ihrer Lizenzinformationen erleichtern.
Für die Online-Übermittlung füllen Sie noch die Felder [.guihint]#Licensing ID# und [.guihint]#Password# mit den xref:generate_application_password[Informationen aus dem Kundenportal.]

Zum Abschluss klicken Sie auf [.guihint]#Save#, um Ihre Angaben zu speichern.


=== Lizenznutzungsinformationen an die {comfull} übermitteln

Einmal eingestellt übernimmt {CMK} den Großteil der Arbeit zur Übermittlung Ihrer Lizenzinformationen.
Sie müssen lediglich jeweils zum Beginn und zum Ende einer Nutzungsphase einmal die Datenübertragung anstoßen.
Nur falls dies in Ihrem Unternehmen nicht möglich ist, müssen Sie xref:manualtrans[die Daten manuell übermitteln.]

Ihre Lizenzinformationen sind für Sie jederzeit transparent einsehbar.
Es werden die Angaben verwendet, die Sie auf den Seiten [.guihint]#License usage# und [guihint]#Edit settings# sehen.


[#directtrans_cee]
==== Direktübermittlung durch {CMK}

Die [.guihint]#Licensing credentials# müssen vor der ersten Übertragung in {CMK} hinterlegt worden sein (siehe xref:setup_cee[Subskriptionsdaten in {CMK} eingeben]).

Haben Sie sich für die Online-Übermittlung entschieden (der entsprechende Knopf ist aktiv), so klicken Sie auf [.guihint]#Submit license usage online#.
{CMK} kümmert sich um den Rest und für Sie entsteht während der gesamten Nutzungsdauer keine weitere Arbeit.
Nach jeder erfolgreichen Übertragung erhalten Sie eine Bestätigung sowie eine Zusammenfassung der übermittelten Informationen.
Diese sieht dann zum Beispiel so aus:

image::license_online_success_cee.png[alt="Anzeige der übermittelten Lizenzinformationen."]

Damit haben Sie erfolgreich die Nutzungsdaten der ersten Lizenzphase an die {comfull} übermittelt.

Ab jetzt übermitteln Sie zum Ende einer Lizenzphase Ihre jeweilige Lizenznutzung mit einem Klick auf [.guihint]#Submit license usage online# an das {CMK}-Kundenportal.
Sobald der Vertrag verlängert oder angepasst wurde, holen Sie sich die neuen Lizenzinformationen mit [.guihint]#Submit license usage online# zurück in {CMK}.
// TK: Das ist auch überraschend, dass man neue Lizenzinformation abholt, wenn man Submit anklickt. Egal.


== Lizenznutzungsinformationen anzeigen

{CMK} beginnt ab dem Start Ihrer Lizenz, die lizenzrelevanten Informationen in Form eines farbigen Diagramms anzuzeigen.

Wenn die Lizenzverwaltung mindestens zwei volle Tage gelaufen ist, sehen Sie ein Diagramm dieser Art:

image::license_usage.png[alt="Graphische Übersicht über die aktuelle Lizenznutzung."]

Anhand der verschiedenfarbigen Elemente können Sie Folgendes ablesen:

* Die rote Linie zeigt das aktuell vertraglich vereinbarte Lizenzlimit.
Damit sind Überschreitungen der Service-Anzahl leicht zu erkennen.
* Die hellblaue Linie zeigt die durchschnittliche Service-Anzahl pro Monat an.
Hierdurch werden Spitzen, die z.B. durch eine Fehlkonfiguration entstehen, geglättet.
* Die dunkelblaue Linie zeigt für jeden Tag die Gesamtzahl der überwachten Services über alle verbundenen Instanzen hinweg an.
* Die grüne Spalte zeigt die durchschnittliche Service-Anzahl im aktuellen Monat.
* Die gelbe Spalte zeigt den ersten Monat, in dem das Lizenzlimit überschritten wird.
* Die lila Spalte zeigt den Monat mit der höchsten Lizenzüberschreitung.

In einer Tabelle unterhalb dieser Grafik sehen Sie eine Übersicht der Services und Hosts, wie sie an die {comfull} gemeldet werden:

image::license_usage_unten.png[alt="Übersicht der Services und Hosts in den verschiedenen Stati."]

In der Lizenzierung wird unterschieden nach:

[cols="~,~"]
|===

|Lizenzierbare Services / Hosts |Anzahl der Services bzw. Hosts, die für die Größe der Lizenzberechnung herangezogen werden.
|Ausgeschlossene Services / Hosts |Services bzw. Hosts, die nicht in die Lizenzgröße eingerechnet werden. Dies sind z.B. Services / Hosts, die nur für interne Testszenarios in Ihrem Unternehmen genutzt werden. Um Services oder Hosts als ausgeschlossen zu markieren, setzen Sie Labels vom Typ `licensing:excluded` entsprechend der Beschreibung  zur xref:labels#create_labels[Erstellung von Labels].
|Schatten-Services / -Hosts |Services bzw. Hosts, die automatisiert und aus technischen Gründen als xref:distributed_monitoring#cmcdump[Schatten-Services bzw. -Hosts] angelegt werden. Sie werden in die Lizenzberechnung nicht einbezogen.
|Cloud-Services / -Hosts |Cloud-basierte Services bzw. Hosts, die für die Größe der Lizenzberechnung herangezogen werden.

|===


[#manualtrans]
== Manuelle Übermittlung

Sollten Sie aus technischen Gründen gezwungen sein, Ihre Lizenzinformationen manuell in das Kundenportal hochzuladen, so gehen Sie dabei folgendermaßen vor:

Öffnen Sie [.guihint]#Setup > Maintenance > Licensing.#
Klicken Sie dann auf den Knopf icon:icon_assume_0[alt="Symbol zur Offline-Übertragung der Lizenzdaten."] [.guihint]#Offline verification# in der {CE} bzw. [.guihint]#Submit license usage offline# in den anderen {EE}.

Sie gelangen auf eine dieser Seiten:
// TK: Nur mal so: Ich hab mir beide Screenshots durchgelesen und versteh es nach wie vor nicht. Wie kompliziert kann man das eigentlich machen?

.Offline-Verifizierung der Lizenz in der {CE}
image::license_offline_verification.png[alt="Seite für Offline-Übertragung der {CE}-Lizenzinformationen.", width=85%]

.Offline-Übertragung der Lizenzinformationen in den anderen {EE}
image::license_offline_submission.png[alt="Seite für Offline-Übertragung der {EE}-Lizenzinformationen.", width=85%]

Folgen Sie nun den Schritten, wie sie im Ablauf auf der Seite dargestellt werden.
// TK: Folgen Sie den Anweisungen auf dieser Seite.
Laden Sie also die geforderten Daten aus {CMK} herunter.
Laden Sie die zugehörigen Dateien als nächstes ins Kundenportal hoch.
Die von dort bereitgestellten Antwortdateien laden Sie dann in {CMK} hoch, um den Prozess abzuschließen.
// TK: Die dort... statt Die von dort ...?
// TK: Antwortdatei statt Antwortdateien? Es gibt doch nur jeweils eine, oder?
// TK: Nur mal so: Die Antwortdatei muss ich ja erstmal aus dem Portal runterladen, bevor ich Sie in CMK hochladen kann, also im Ganzen: Download > Upload > Download > Upload. Oh weia!

Achten Sie darauf, dass Sie in einem xref:glossar#distributed_monitoring[verteilten Monitoring] sowohl die Übermittlungen zum Kundenportal als auch die aus dem Kundenportal nicht nur auf der Zentralinstanz, sondern auch auf allen Remote-Instanzen ausführen müssen.
// TK: Ich glaube, hier muss statt glossar#distributed_monitoring glossar#distributed_setup[verteiltes Setup] verlinkt werden.
Beim xref:glossar#distributed_setup[verteilten Setup] erfolgt die komplette Abwicklung der Lizenzierung über die Zentralinstanz.
