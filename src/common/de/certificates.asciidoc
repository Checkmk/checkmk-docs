// -*- coding: utf-8 -*-
// IGNORE
// NONASCII
// NO-LUNR
// SH: Ist NO-LUNR hier korrekt? Ich verstehe den Doku-Leitfaden so, dass wir damit Frischlinge von der Suche ausschließen (können) bis zur Freigabe...
include::global_attr.adoc[]
= Interne Zertifikate von {CMK} im Überblick (Certificate overview page)
// SH: Gibt es eine Zeichenbegrenzung, dürfen es im Browser gerendert zwei Zeilen sein? Ich habe die Headline jetzt so gewählt, dass sie einen guten Zeilenumbruch hat, siehe Preview. Bei Heise online orientierten wir uns an den SEO-Vorgaben von Google, die die Maximallänge für die Darstellung in Suchergebnissen definieren (2023 waren das 80 Zeichen inkl. Leerzeichen, Tendenz sinkend). Das iX-Magazin und Springer Nature waren rigoroser, Cut bei 50-70 Zeichen. Eine typische Heise-Headline unter 70 Zeichen: "Missing Link: Wie es bei Linux ohne Linus Torvalds weiterginge" (62 Zeichen). Ich hake nach, weil mein Vorschlag 72 Zeichen lang ist. Das ist in vielen Online-Kontexten jenseits der magischen Grenze.
// SH zum Artikel: Darf der englische Begriff "Certificate Overview (page)" auch im Deutschen schon in die Headline? Sonst würde ich hier "Interne Zertifikate in Checkmk" schreiben. Wenn es kürzer sein muss, können wir "in Checkmk" weglassen oder "Certificate Overview page in Checkmk" schreiben, das funktioniert in beiden Sprachen. Wenn es länger sein darf, siehe oben. Wir können sonst "Interne Checkmk-Zertifikate" etc. schreiben, um unter 70 Zeichen zu bleiben. Ich muss bloß wissen, was gilt.
:title: Certificate Overview Page: Interne Zertifikate in Checkmk im Überblick
:description: Die Certificate overview in der {CMK}-GUI listet die internen Zertifikate auf. Lesen Sie hier, welche Informationen Sie diesem Feature entnehmen können.
// SH: Meta-Description: 152 Zeichen inkl. Leerzeichen (von max. 155)
:keywords: omd_https, certificate, CA

{related-start}
link:ports[Referenzartikel zu den Ports in {CMK}]
link:omd_https[Die Weboberfläche mit HTTPS absichern]
link:distributed_monitoring[Verteiltes Monitoring mit {CMK}]
link:security[Übersicht über die Sicherheits-Features in Checkmk]
{related-end}

// SH: Diese Form der Linkbox habe ich aus einem anderen Artikel einkopiert. Die Syntax funktioniert. Im Dokuleitfaden finde ich jedoch eine leicht abweichende Syntax: xref:ports#[Referenzartikel zu den Ports in {CMK}]. Was gilt? Und wieso? Hat das Auswirkung auf unser Tracking?

// ML: Ich würde mir das "page" sparen - sofern das kein Markenname sein soll ;) Im Text dann tendenziell: [.guihint]#Certificate overview#-Seite, oder "Die Seite ..." oder ähnlich. 
//SH an TK: Was sagst du? "page" präzisiert, dass es um eine definierte Seite in der GUI geht. Falls das redundant ist, lasse ich es gerne weg. Ich habe bei meinen Recherchen keine klare Antwort gefunden, ob "page" fester Bestandteil unserer Software-Nomenklatur ist. Im Werk kam es vor.

== Einleitung
// SH: Die Einleitung erläutert, grenzt ab, illustriert mit einem Überblicks-Screenshot. Scope eng halten.

Certificate Authorities (CA) sind vertrauenswürdige Stellen, die die interne Kommunikation durch die Ausgabe von Zertifikaten absichern, etwa zwischen einer Instanz und den ihr zugeordneten Hosts sowie zwischen den Instanzen im verteilten Monitoring.
{CMK} sichert Monitoring-Instanzen über eigene CAs ab.
Dabei ist zunächst unerheblich, welche Edition Sie für Ihr Monitoring im Einsatz haben oder in welchem Setup Sie Systeme überwachen: {CMK} stattet im Hintergrund alle Monitoring-Instanzen automatisch mit eigenen CAs und internen Zertifikaten aus, die für den Betrieb und für die interne Kommunikation der Instanzen grundlegend sind.

Über [.guihint]#Setup > Maintenance > Certificate overview# gelangen Sie innerhalb der grafischen Benutzeroberfläche von {CMK} in einen Bereich, der diese internen Zertifikate auflistet: die [.guihint]#Certificate overview.#
Die Oberfläche dieses Features sieht in allen Editionen identisch aus und präsentiert auf einen Blick alle grundlegenden Zertifikate, die beim Einrichten Ihrer Instanz {CMK}-seitig erstellt und hinterlegt wurden.

Die Seite hat reinen Informationscharakter und dient als interner Schnellzugriff -- etwa, um die Gültigkeit und die Fingerprints der vorinstallierten Zertifikate zu überprüfen.
Beim Verdacht auf Zertifikatsprobleme kann die Übersicht das Troubleshooting beschleunigen.
Dafür ist die [.guihint]#Certificate overview page# die erste Anlaufstelle.

Drei Certificate Authorities werden beim Erzeugen einer {CMK}-Instanz als vertrauenswürdige Herausgeberinnen von Zertifikaten stets individuell per Zufallsgenerator erzeugt:

. eine CA zum Signieren des Agenten der Instanz,
// (Site 'mysite' agent signing CA)
. eine CA für den lokalen Message Broker,
// (Site 'mysite' broker CA?)
. eine CA für die Absicherung der Distributed-Piggyback-Kommunikation.
// (Site 'mysite' local CA?)

// SH: Abgrenzungsproblem wegen inkonsistenter Terminologie: Sind hier wirklich CAs = Certificate Authorities gemeint oder geht es bereits um Zertifikate, die von übergeordneten CAs abgeleitet sind? Unsere IT verwendet den Begriff CA etwas "sloppy", meinte MFS: Mal ist mit CA der Herausgeber von Zertifikaten gemeint, mal steht CA für das Herausgeberzertifikat/CA-Zertifikat. CA steht in beiden Kategorien, einmal als Subjekt und dann als Herausgeber. Wäre nicht Subject = Zertifikat und Issuer = die vertrauenswürdige Stelle/der Herausgeber von Zertifikaten? Beides wird synonym in unserer GUI als CA bezeichnet. Wir wollen im Handbuch so präzise wie möglich formulieren, dabei aber offen bleiben für künftige Änderungen. Hierzu bitte noch einen Prüfblick von MFS, der mit dem Problem vertraut ist und das Gemeinte hinter der Terminologie erfasst. Ich fand es schwierig, etwas präzise zu beschreiben, was in der GUI uneindeutig deklariert ist. Ich will keinen Unfug nach außen tragen.


// ML: Das Wording in der Tabelle oben kommt nicht so ganz hin, "CA als lokaler Message Broker" - da ist wohl die CA FÜR den Message-Broker gemeint, damit der mit den Gegenstellen plaudern darf. -- SH: Danke, ist umgesetzt.

// ML: Zu sloppy: Ich würde auch eher schlicht von Zertifikatskette reden und den Rest Lesern/Entwicklern überlassen ... (bei mysite.pem zum Beispiel ist "mysite_pro" aus der Spalte "subject name" der Common Name (CN)) 
// SH: Das ist einer der Knackpunkte im Artikel. Wie präzise können, wollen und müssen wir sein? Je präziser der Artikel ist, desto hilfreicher für die Leser. Aber wenn der Artikel präziser ist als die Ansprache in der GUI, haben wir eine Disprepanz zwischen Erklärtext und Erklärtem. Das stiftet Verwirrung. Hierzu möchte ich das Review von Thomas abwarten. TK, wie würdest du den Begriffskonflikt lösen?

// ML: Oder mach es Dir einfach, lies eine der pem-Dateien aus und füge den Kram als Terminal-Session ein - würde dem Artikel was Hübsches hinzufügen ;) Etwa so:

////
[{shell}]
----
{c-user} while openssl x509 -noout -text; do :; done < ca.pem
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            6a:c7:03:96:e7:e1:f9:09:04:d5:65:91:21:e8:ba:80:c4:74:85:46
        Signature Algorithm: sha512WithRSAEncryption
        Issuer: CN = Site 'mysite_pro' local CA, O = Checkmk Site mysite_pro
        Validity
            Not Before: Nov  7 14:50:38 2025 GMT
            Not After : Nov  7 14:50:38 2035 GMT
        Subject: CN = Site 'mysite_pro' local CA, O = Checkmk Site mysite_pro
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:b3:6d:d4:f9:35:d6:2d:fd:1f:aa:5d:ec:26:0b:

----
////

// [discrete]
// === Screenshot-Platzhalter
.[.guihint]#Certificate overview#: Übersicht der internen {CMK}-Zertifikate
image::certificate_overview_page.png[alt="Certificate Overview Page in Checkmk.",fullscreen=1]

// ML: Der erste Satz ist etwas verwirrend, die Einträge enthalten ja alle die Metadaten
// SH: Stimmt, ich schreibe einen neuen ersten Satz davor, der das übergeordnet umreißt. Statt "Die CAs und die CA-Zertifikate als Herausgeberzertifikate" schreibe ich wohl besser allgemein von "Zertifikatsketten".
Die Übersicht listet die internen Zertifikatsketten mit ihren Metadaten auf. Sie sind in der Übersicht in die Rubriken [.guihint]#Subject Name# (die ausgegebenen Zertifikate) und [.guihint]#Issuer# (deren ausgebende Instanz, die Ursprungs-CA) eingeteilt mit ihrer jeweiligen Bezeichnung samt Erstellungs- und Ablaufdatum.
Für jedes Zertifikat sind neben der Laufzeit dessen genaue Bezeichnung, der individuelle Fingerprint, der Schlüsseltyp (RSA), die Schlüssellänge in Bits und der Speicherort hinterlegt.
Diese Daten unterscheiden sich von Instanz zu Instanz und sind im Screenshot nur beispielhaft veranschaulicht.
Werfen Sie zur Orientierung ruhig einen Blick in Ihre eigene Instanz, die Schlüssellänge und andere Elemente können vom Beispiel abweichen.

Die [.guihint]#Certificate overview page# listet Ihnen dort per Default fünf Zertifikate auf:

// SH: Direkt als Tabelle anlegen mit Referenzen? Oder erst Bullet Points für den Überblick und dann die Tabelle? Inhaltlich sollte ich das nochmal mit MFS durchgehen, um Konsistenz zur Tabelle zu wahren. Die Bezeichnung Site-Zertifikat ist zu prüfen. Was ist der korrekte Begriff für die Zertifikatsklasse, die mTLS absichert?

* das Root-Zertifikat der Instanz.
* ein Zertifikat, das mTLS absichert -- es ist für das "m" in mTLS zuständig, also für die beidseitige (mutual) sichere Authentifizierung von Client und Server, die das Standard-TLS-Protokoll erweitert: So werden bei {CMK} die Agenten signiert.
* das lokale Message-Broker-Zertifikat.
* das CA-Zertifikat, mit dem die individuellen Zertifikate für die Message-Broker-Kommunikation mittels der quelloffenen Broker-Software RabbitMQ abgesichert werden.
* ein Zertifikat, das der SSL-Verschlüsselung dient.

[TIP]
====
Dabei handelt es sich um den Standard-Bausatz, der systemintern jeder Instanz für den Betrieb mit auf den Weg gegeben wird.

Die Liste erhebt keinen Anspruch auf Vollständigkeit.
====


// Link zu omd_https einbauen in AsciiDoc-Syntax: nachschauen.

// SH: MFS betonte, dass wir einen Satz zum Ausschluss von Vollständigkeit hineintexten müssten. Allerdings kann die Certificate Overview Page im jetzigen Zustand vom User gar nicht erweitert werden, soweit ich Maximilian Wirtz verstanden habe. Zumindest nicht in absehbarer Zeit. Ist der Ausschluss auf künftige Szenarien bezogen -- rein prophylaktisch, oder könnten da auch jetzt schon mehr Einträge stehen? Im Distributed Monitoring vielleicht?

// SH: Warum ist das so, dass Cmk eine eigene CA hat/ mitliefert? Sukzessive aufbaubar.

// SH: Hier werden die Zertifikate für die interne Kommunikation beschrieben:
// Root-Zertifikat.
// Site-Zertifikat für die mTLS-Kommunikation zwischen Agent Controller und Agent Receiver. Stimmt hier der Begriff Site-Zertifikat?
// Local Message Broker CA und
// Zertifikat für die Absicherung der Distributed Piggyback-Kommunikation.
// Zertifikat Signing Agent: Für das "m" in mTLS zuständig, weil den Zertifikaten gegenseitig vertraut werden muss.
// Das sind die Stichwörter, nach denen ich suchen kann im Handbuch.

== Zertifikate für die interne {CMK}-Kommunikation -- Referenztabelle

[cols=5, options="header"]
|===
| Bezeichnung | Dateipfad im [.guihint]#etc#-Ordner | Funktion | Typ | Komponente
// SH: Reicht in der fünften Spalte als Header "Komponente" oder brauchen die Leser einen Hinweis, dass sie hier vertiefend weiterlesen können?
| Root-Zertifikat | [.guihint]#ssl/ca.pem# | sichert die Instanz | CA-Zertifikat | xref:livestatus#[Livestatus], xref:wato_monitoringagents#[Monitoring-Agenten], ... (Link folgt)
// SH: Livestatus und Agent Monitoring sind verlinkt. MFS recherchiert, was da weiter zu referenzieren ist.
| ? | [.guihint]#ssl/agent/ca.pem#| signiert den Agenten und sichert mTLS ab – Certificate Signing Request von der Gegenseite wird mit diesem Zertifikat signiert  | CA-Zertifikat  | xref:wato_monitoringagents#[Monitoring-Agenten]
// SH: Bezeichnung unklar: Ist es ein Intermediate-Zertifikat? Laut Maximilian haben wir in der Overview aber keine Intermediates. Dann müsste es ein Root-Zertifikat sein. Wir klären die korrekte Bezeichnung noch. Zur Komponente: auf die Monitoring-Agenten verweisen.
| Site-Zertifikat | [.guihint]#​sites/mysite.pem# | sichert die Netzwerkkommunikation verschiedener Komponenten | sichert Kommunikation ab | xref:livestatus#[Livestatus] und xref:wato_monitoringagents#[Monitoring-Agenten] (Agent Receiver)
// SH: Agent Receiver und Livestatus, verweisen auf Monitoring-Agenten. Braucht der Agent Receiver dann noch einen eigenen Link?
| CA-Zertifikat für RabbitMQ | [.guihint]#rabbitmq/ssl/ca_cert.pem# | sichert die Zertifikate der individuellen Message Broker, etwa für Distributed Piggyback-Kommunikation | CA-Zertifikat | xref:piggyback#[Piggyback] und xref:distributed_monitoring#[Distributed Monitoring] 
| SSL-Zertifikat | [.guihint]#​rabbitmq/ssl/cert.pem# | dient der SSL-Verschlüsselung: sichert Netzwerkkommunikation des Message Brokers ab |  sichert Kommunikation ab | xref:piggyback#[Piggyback] und xref:distributed_monitoring#[Distributed Monitoring]
// SH: Wording noch nicht präzise genug. Die exakte Formulierung finden wir noch mit MFS. 
|===

Die allgemeine Steuerung vertrauenswürdiger Zertifikate für die TLS-verschlüsselte Kommunikation zwischen dem {CMK}-Server und den Agenten auf Ihren überwachten Hosts ist in einem gesonderten Bereich der Benutzeroberfläche zu finden.
Die Einstellungen dafür lassen sich unter [.guihint]#Setup > General > Global Settings > Edit global setting# einsehen und verwalten.
Von der [.guihint]#Certificate overview# Ihrer Instanz aus können Sie die [.guihint]#settings# wahlweise über den gleichnamigen Text-Link oberhalb der Zertifikatstabelle ansteuern oder dem Menü-Eintrag [.guihint]#Related > Trusted certificate authorities for SSL# dorthin folgen.


[IMPORTANT]
====
Für die Zertifikate des System-Apache, also des Apache-HTTP-Webservers Ihres Systems, sind Sie als Nutzer selbst verantwortlich.

Diese Zertifikate sind relevant etwa für ein Agenten-Update, für die Nutzung der REST-API und das Web-Interface.
====

Hier ist noch zu erwähnen, dass auch in einem verteilten Monitoring mit zentralem Setup die Weitergabe von Einstellungen über eine REST-API läuft.
Wenn Sie wissen wollen, wie Sie Ihre Weboberfläche mit HTTPS absichern, können Sie im xref:omd_https#[HTTPS-Monitoring-Kapitel] weiterlesen.

// Schlüssellänge etc. kann sich ändern, die sollen User in ihren eigenen Instanzen anschauen.
// Rein muss: "kein Anspruch auf Vollständigkeit" --> habe ich in eine Admonition gepackt. Dazu ist eine Frage anhängig.
// Bezeichnung des Zertifikats, Typ des Zertifikats: Handelt es sich um ein CA-Zertifikat oder um eines, mit dem Kommunikation abgesichert wird?
// Dann Link zu der Komponente im Handbuch ergänzen. Done.

// SH: Abgrenzung zu omd_https, separat: Expliziter Hinweis evtl. als Admonition oder unter die Tabelle, dass die Zertifikate für die HTTPS-Kommunikation in der Verantwortung der Server-Admins liegen, und auf omd_https verlinken. Done. 

// SH nach Gespräch mit MW: Einen direkten Nutzen für die Anwenderinnen und Anwender erfüllt diese Seite nicht. Sie dient einem internen Zweck als Schnellzugriff für das Troubleshooting durch Checkmk-Consultants, die hier auf einen Blick die drei Checkmk-eigenen Certificate Authorities finden, die Ihre Instanz absichern.

// Scope eng halten. Consultants machen damit was. Die Seite ist eine reine Information zur Recherche. "Ich habe ein Problem, ich möchte etwas wissen" - nicht: ich möchte etwas tun. Informationsseite. Es gibt hier nichts zu tun. Scope: diese Seite, die Certificate Overview Page. Wenn ich ein Problem habe mit Zertifikaten, die von Checkmk selbst ausgestellt werden, ist das die erste Anlaufstelle.

// Information reinbringen: Wie sie mit anderen Bereichen zusammenhängt. "Wenn du mehr Informationen zu xy haben willst... dann schau hier: ... (Link)" ----> Wo werden die Zertifikate benutzt? Querverweis auf die Artikel. "Guck dir das an, dann siehst du unter Umständen schon, woran es liegen könnte." ---> Referenztabelle

// ... zwischen Central und Remote site. Für REST-API etc. geh rüber zu omd_https. Möglicherweise reicht eine Tabelle, von der aus die Leser in die jeweiligen Artikel weitergeschickt werden. Livestatus-Zertifikate > Remote und Central site etc.

// SH Abgrenzung: Für die Zertifikate des System-Apache ist der Nutzer selber verantwortlich. Diese Zertifikate sind relevant für Agenten-Update, REST-API und Web-Interface. Hier ist noch zu erwähnen, dass auch in einem Distributed Setup (in einem verteilten Monitoring mit einem zentralen Setup) die Propagation von Einstellungen über eine REST-API läuft und hinsichtlich des System-Apache: omd_https.

// Für die 2.5 müssen wir nochmal ran. Für die 2.4 haben wir erstmal alles, was rein muss.

// Wir haben noch keine Möglichkeit, die Zertifikate auszutauschen zurzeit. Ist der Download-Button schon drin? Nachgeschaut: Button, um Zertifikate auch herunterzuladen: Nein, existiert noch nicht. Künftige Erweiterung: Den Austausch von Zertifikaten zu beschreiben, wenn Zertifikate kompromittiert sind. Da gibt es bisher eine Möglichkeit, das auf der Kommandozeile zu tun (sagte Max, siehe Notizen). Sehr hacky, eher für die KB. ---> Sollten wir das im Artikel überhaupt erwähnen?
