// -*- coding: utf-8 -*-
// IGNORE
// NONASCII
// NO-LUNR
include::global_attr.adoc[]
= Zertifikate in {CMK} im Überblick
:title: Zertifikate in {CMK} im Überblick
:description: Die Seite Certificate overview in der Checkmk-GUI listet die internen Zertifikate auf. Lesen Sie hier, welche Informationen Sie der Seite entnehmen können.
// SH: Meta-Description: 155 Zeichen inkl. Leerzeichen (von max. 155) 
:keywords: certificate, CA

{related-start}
// xref:ports#[Ports]
xref:omd_https#[Weboberfläche mit HTTPS absichern]
xref:distributed_monitoring#[Verteiltes Monitoring]
xref:security#[Sicherheit (Security)]
{related-end}

[#intro]
== Einleitung

Zertifikate gewährleisten den sicheren Betrieb Ihres Monitoring: Für die ein- und ausgehende Kommunikation in Ihrer {CMK}-Umgebung bestätigen sie die Vertrauenswürdigkeit der verwendeten Schlüssel, zum Beispiel zwischen den xref:glossar#agent[Agenten] und Ihrer xref:glossar#site[{CMK}-Instanz] oder im verteilten Monitoring bei der Kommunikation zwischen xref:glossar#central_setup[Zentralinstanz und Remote-Instanzen]. 

Bei {CMK} sind Zertifikate im PEM-Format hinterlegt – auch für die {CMK}-seitigen Certificate Authorities (CA), die sich mit je einem CA-Zertifikat jeweils die eigene Vertrauenswürdigkeit attestieren.
PEM steht für Privacy-Enhanced Mail und ist ein einfach handhabbares Textdateiformat zum Aufbewahren und Teilen kryptografischer Schlüssel, Zertfikate und Anfragen. 
Dateien im PEM-Format sind Klartextdateien und lassen sich als solche per Texteditor leicht einsehen und bearbeiten.

.[#certificates]#Wie funktionieren Zertifikatsketten?#
[%collapsible]
====

Aus allen Daten eines Zertifikats wird ein Hash-Wert berechnet, der in Form einer Abfolge von Buchstaben und Zahlen die eindeutige digitale Kennung dieses Zertifikats darstellt. 
Dieser "Fingerprint" dient als unveränderlicher Prüfwert, mit dem sich die Echtheit von Zertifikaten feststellen lässt.
Kommunikation wird erst nach erfolgreicher Prüfung der dafür benötigten Zertifikate übertragen, und zwar in verschlüsselter Form. 
SSL/TLS-Zertifikate ermöglichen eine sichere Kommunikation zwischen Webbrowser und Website und stellen sicher, dass während der Übertragung die Daten weder mitgelesen noch manipuliert werden können.
Jeder Eingriff in ein Zertifikat verändert dessen Prüfwert und fällt beim Abgleich mit einer vertrauenswürdigen Quelle auf.

Certificate Authorities (CA) sind solche vertrauenswürdigen Stellen, die Zertifikate ausgeben und die Herkunft vorliegender Zertifikate prüfen. 
Nach der Überprüfung der Echtheit eines Schlüssels bestätigen sie die digitale Identität der überprüften Entität.
{CMK} sichert Ihre xref:glossar#site[{CMK}-Instanzen] über eigene Certificate Authorities ab:
Indem diese Softwarekomponenten die eingesetzten Zertifikate auf Gültigkeit und Übereinstimmung mit den für sie hinterlegten Werten überprüfen, authentifizieren sie die systeminterne Kommunikation – beispielsweise zwischen einer xref:glossar#site[Instanz] und den ihr zugeordneten xref:glossar#host[Hosts] oder im verteilten Monitoring zwischen den Instanzen. 
Ob Sie Systeme im xref:glossar#distributed_monitoring[verteilten Monitoring] oder mit einer Einzel-Instanz überwachen, ist dabei unerheblich:
{CMK} stattet beim Implementieren alle Monitoring-Instanzen mit den CAs und Zertifikaten aus, die für den Betrieb und für die Kommunikation zwischen den Komponenten eines {CMK}-Setups unerlässlich sind, etwa zwischen den xref:glossar#agent[Agenten] und der Instanz. 
Vereinfacht gesagt prüft die Zertifizierungsstelle die Identität des Antragstellers (das kann eine Website, aber auch eine Softwarekomponente sein) und bestätigt dessen öffentlichen Schlüssel in einem Zertifikat, das zur Kommunikation berechtigt.

Die CA signiert das Zertifikat mit ihrem privaten Schlüssel, um dessen Authentizität zu gewährleisten. 
Die Zertifikate, die CAs ausstellen, werden CA-Zertifikate beziehungsweise Herausgeberzertifikate genannt. Als digitaler Ausweis ermöglichen sie die sichere verschlüsselte Kommunikation.
Dem liegt eine Vertrauenskette (Zertifikatskette) zugrunde: Die beteiligten Systemkomponenten vertrauen auf eine vordefinierte Liste von CA-Zertifikaten.
Herausgeberzertifikate bilden das Fundament sicherer Internetverbindungen durch verschlüsselte Datenübertragung zwischen Browser und Website – dabei gilt HTTPS als die sichere Variante des Internet-Protokolls HTTP und verwendet für die Datenübertragung TLS- oder SSL-Verschlüsselung.

Bei {CMK} geschieht etwa das Signieren der Agenten in einer Verschlüsselungsform, die über SSL/TLS sogar noch hinausgeht: Die Kommunikation zwischen Agent Receiver (in der Instanz) und Agent Controller (auf dem überwachten Host) findet per mTLS statt, asynchron und in Ende-zu-Ende-Verschlüsselung. 
Das "m" in mTLS steht für das gegenseitige (mutual) Bestätigen einer Vertrauensbasis: eine sichere Authentifizierung von Client und Server, die das Standard-TLS-Protokoll erweitert.
Eine dafür zuständige Certificate Authority beantwortet Signierungsanfragen des Agent Controller von Hosts im Monitoring. 
Kompromittierte Schlüssel lassen sich bei diesem Verfahren leicht einzeln austauschen. 
// SH: Der letzte Satz verweist eher schon auf die 2.5.0, wenn wir Zertifikate auf einfache Weise per Knopfdruck herunterladen und austauschen können. 
// SH: Dennoch können wir allgemein schon erwähnen, dass Schlüssel sich austauschen lassen. Auf der Kommandozeile geht das schon heute. 
====

Die in {CMK} vorinstallierten Zertifikate können Sie über die Seite [.guihint]#Certificate overview# einsehen.

[#overview]
== Zertifikatsübersicht in {CMK}
Über [.guihint]#Setup > Maintenance > Certificate overview# öffnen Sie die Seite [.guihint]#Certificate overview#.
Hier finden Sie auf einen Blick alle grundlegenden Zertifikate, die beim Einrichten Ihrer Instanz {CMK}-seitig erstellt und hinterlegt wurden.
// TK: grundlegenden Zertifikate: Warum die Einschränkung? Gibts noch andere? Ich hoffe nicht ;-)
// SH: Doch, seufz. Soweit ich verstanden habe, gibt es weitere Zertifikate, die hier nicht gelistet sind:
// SH: Die Bakery-Zertifikate zum Beispiel: Signaturschlüssel. Sind dasselbe wie Zertifikate für Netzwerkkommunikation. Tw. verwendet man die gleichen Verschlüsselungsalgorithmen. Dienen aber nicht zum Verschlüsseln von Kommunikation, sondern zur Herkunftsprüfung. Wir müssen nach dem Zweck gehen. 
// SH: Die TLS-Zertifikate in Edit global setting (über der Certificate overview verlinkt). 
// SH: Beim verteilten Monitoring findet sich in den Remote-Instanzen hier nicht die CA für das Signieren der RabbitMQ-Zertifikate, die gibt es nur in der Zentralinstanz. 
// SH: Beim verteilten Monitoring wächst die Liste mit jeder Remote-Instanz, die eingebunden wird. Das erwähne ich nun im Text.
// SH: Grundlegende Zertifikate: Kommunikationsrelevante Zertifikate. Dann haben wir wieder Problem mit den TLS-Zertifikaten für HTTPS, die hier nicht drin sind.
Die Seite hat reinen Informationscharakter und dient als interner Schnellzugriff – etwa, um die Gültigkeit und die Fingerprints der vorinstallierten Zertifikate zu überprüfen. 
Beim Verdacht auf Zertifikatsprobleme kann die Übersicht das Troubleshooting beschleunigen.
Dafür ist die Seite [.guihint]#Certificate overview# die erste Anlaufstelle.

.Übersicht der {CMK}-Zertifikate
image::certificate_overview_page.png[alt="Die Seite 'Certificate Overview' in {CMK}.",fullscreen=1]

Die [.guihint]#Certificate overview#-Seite listet Ihnen die Zertifikate der Checkmk-Komponenten mit ihren Metadaten auf: in der Rubrik [.guihint]#Common Name (Subject)# die ausgegebenen Zertifikate und unter [.guihint]#Common Name (Issuer)# deren Herausgeber (Certificate Authority), jeweils mit dem dazugehörigen Erstellungs- und Ablaufdatum.
Für jedes Zertifikat sind neben der Laufzeit der individuelle Fingerprint, der Schlüsseltyp (RSA), die Schlüssellänge in Bits, der Speicherort mit Dateipfad und einen knappen Verwendungszweck ([.guihint]#Purpose#) hinterlegt.
Der vollständige Fingerprint wird als Mouseover-Effekt eingeblendet, wenn Sie den Cursor in der [.guihint]#Certificate overview# auf den jeweiligen Fingerprint-Eintrag bewegen und mit ihm dort verweilen.
Werfen Sie zur Orientierung ruhig einen Blick in Ihre eigene Instanz, die Schlüssellänge und andere Elemente können vom Beispiel abweichen.

Drei Certificate Authorities (CA) werden beim Erzeugen einer {CMK}-Instanz als vertrauenswürdige Herausgeberinnen von Zertifikaten stets individuell erzeugt, die Seite listet deren CA-Zertifikate (Herausgeberzertifikate) auf: je ein CA-Zertifikat für den lokalen Message Broker, eines zum Signieren der Agentenschlüssel bei der mTLS-Authentifizierung und eines für die Absicherung der xref:piggyback#distributed_piggyback[Distributed-Piggyback-Kommunikation]. 
Standardmäßig sind für das Einzelmonitoring fünf Zertifikate aufgelistet. 
Im verteilten Monitoring enthält die Zertifikatsübersicht Ihrer Zentralinstanz für jede überwachte Remote-Instanz einen weiteren Eintrag. 

// [TIP]
// ====
// Dabei handelt es sich um den Standard-Bausatz, der systemintern jeder Instanz für den Betrieb mit auf den Weg gegeben wird.
// Die Liste erhebt keinen Anspruch auf Vollständigkeit und zeigt den Stand beim Erstellen des Artikels -- künftige {CMK}-Versionen könnten weitere Zertifikateinträge in der Übersicht enthalten, etwa für OpenTelemetry und Ultimate.
// Daher kann es sein, dass die Liste in künftigen Versionen ein leicht abweichendes Erscheinungsbild aufweist.
// ====

[#table]
=== Zertifikate der {CMK}-Komponenten

// SH: Spaltenbreite in der Tabelle ggf. anpassen für besseren Textfluss, sobald der Text final steht.

// [cols=4, options="header"]
[cols="25,35,~,~",options="header"]
|===
| Dateipfad im Ordner `~/etc` | Funktionsbeschreibung | Position in der Zertifikatskette | {CMK}-Komponenten
// SH: Reicht in der fünften Spalte als Header "Komponente" oder brauchen die Leser einen Hinweis, dass sie hier vertiefend weiterlesen können?
| `ssl/ca.pem` | _Root-Zertifikat_: sichert die Instanz. | CA-Zertifikat | xref:glossar#livestatus[Livestatus], xref:glossar#agent[Monitoring-Agenten]
// SH: Livestatus und Agent Monitoring sind verlinkt. MFS recherchiert, was da weiter zu referenzieren ist.
| `ssl/​sites/mysite.pem` | _Instanz-Zertifikat_: bestätigt die Echtheit des Schlüssels, der für die Netzwerkkommunikation verwendet wird – das lokale Message-Broker-Zertifikat. | sichert Kommunikation ab | xref:wato_monitoringagents#agents[Der {CMK}-Agent (Agent Receiver)] und xref:glossar#livestatus[Livestatus]
| `ssl/agent/ca.pem` | _CA-Zertifikat für Signierung der Agentenschlüssel_: signiert den Agenten und sichert mTLS ab – zuständig für die beidseitige (mutual) sichere Authentifizierung von Client und Server, die das Standard-TLS-Protokoll erweitert. Der Certificate Signing Request von der Gegenseite (Agent Controller von Hosts im Monitoring) wird mit diesem Zertifikat signiert.  | CA-Zertifikat  | xref:glossar#agent[Monitoring-Agenten], xref:hosts_setup#hosts_autoremove[Hosts erstellen und bearbeiten] und xref:wato_monitoringagents#bakery[Agenten-Bäckerei]
// SH: Bezeichnung unklar: Ist es ein Intermediate-Zertifikat? Laut Maximilian haben wir in der Overview aber keine Intermediates. Dann müsste es ein Root-Zertifikat sein. Wir klären die korrekte Bezeichnung noch. Zur Komponente: auf die Monitoring-Agenten verweisen. Ist der Bakery-Verweis noch aktuell?
| `rabbitmq/ssl/ca_cert.pem` | _CA-Zertifikat für RabbitMQ_: sichert die Zertifikate der individuellen Message Broker, etwa für Distributed Piggyback-Kommunikation. Dafür verwendet {CMK} die quelloffene Broker-Software RabbitMQ. | CA-Zertifikat | xref:glossar#piggyback[Piggyback] und xref:glossar#distributed_monitoring[Verteiltes Monitoring]
| `rabbitmq/ssl/cert.pem` | _SSL-Zertifikat_: dient der SSL-Verschlüsselung und sichert Netzwerkkommunikation des Message Brokers ab. |  sichert Kommunikation ab | xref:glossar#piggyback[Piggyback] und xref:glossar#distributed_monitoring[Verteiltes Monitoring]
// SH: Wording noch nicht präzise genug. Die exakte Formulierung finden wir noch mit MFS?
| `​rabbitmq/ssl/multisite_certs/&#8203;mysite_remote_cert.pem` | _Message-Broker-Zertifikat_ für ein Setup mit Remote-Instanzen (Multisite message broker certificate): Jede Remote-Instanz erhält ein solches Remote-Instanz-Zertifikat, das die Echtheit des Schlüssels bestätigt, der für die Kommunikation zwischen Zentral- und Remote-Site verwendet wird. Die Seite [.guihint]#Certificate Overview# der Zentralinstanz listet alle ihr zugeordneten Remote-Instanz-Zertifikate auf. | sichert Kommunikation ab – dies ist nur in einem verteilten Monitoring mit zentralem Setup relevant | xref:glossar#central_setup[verteiltes Monitoring mit zentralem Setup] 
// SH: Durch die Auszeichnung der Dateipfade mit Backticks in Konsolenschrift wird die erste Spalte ungebührlich breit: Das fangen wir mit einem Zeilenumbruch in der letzten Zeile ab. Wir diskutieren im KNW-Team noch, ob wir dort ein Pfeilchen als Zeilenfortsetzungssymbol setzen. Um den Zeilenumbruch kommen wir an der Stelle wohl nicht umhin. Die aktuelle Lösung ist mit MFS abgestimmt.
|===

Die allgemeine Steuerung vertrauenswürdiger Zertifikate für die TLS-verschlüsselte Kommunikation zwischen dem {CMK}-Server und den Agenten auf Ihren überwachten Hosts ist in einem gesonderten Bereich der Benutzeroberfläche zu finden.
Die Einstellungen dafür lassen sich unter [.guihint]#Setup > General > Global Settings > Edit global setting > Trusted certificate authorities for SSL# einsehen und verwalten.
Von der Seite [.guihint]#Certificate overview# aus können Sie diese Einstellung öffnen mit dem Menüeintrag [.guihint]#Related > Trusted certificate authorities for SSL#. In einem xref:glossar#central_setup[verteilten Monitoring mit zentralem Setup] läuft die Weitergabe von Einstellungen über eine REST-API.

[IMPORTANT]
====
Schlüssel und zugehörige Zertifikate für den System-Apache müssen mit Root-Rechten durch den Serveradministrator hinterlegt werden!
====

Zertifikate des System-Apache, also des Apache-HTTP-Webservers Ihres Systems, sind relevant etwa für ein Agenten-Update, für die Nutzung der REST-API und die Weboberfläche.
Dafür sind Sie als Serveradministrator selbst verantwortlich.
Der Instanzbenutzer einer {CMK}-Instanz hat in der Regel keine Zugriffsrechte: Diese Zertifikate sind zwar wichtig, werden aber in der Seite nicht aufgelistet, weil sie nicht Bestandteil der {CMK}-Software sind.
Wenn Sie wissen wollen, wie Sie Ihre xref:omd_https#[Weboberfläche mit HTTPS absichern], können Sie im gleichnamigen Artikel weiterlesen.

// TK: Von der Komplexität sehr ähnlich zu Deiner Seite ist übrigens der Artikel analyze_configuration (1 Seite in der GUI, aber da kann man wenigstens ein bischen was tun).

// SH: Download-Button für PEM-Dateien (Werk 18677): Wir haben noch keine Möglichkeit, die Zertifikate auszutauschen (Stand 21.11.2025 für die 2.4.0). 
// SH: Im Daily Build der 2.5.0 ist der Download-Button schon drin. 
// SH: Künftige Erweiterung des Artikels: Den Austausch von Zertifikaten beschreiben, wenn Zertifikate kompromittiert sind. 
// SH: Da gibt es bisher eine Möglichkeit, das auf der Kommandozeile zu tun (sagte Max, siehe Notizen). 
// SH: Sehr hacky. ---> Erwähnen wir (noch) nicht im Artikel. Es zeichnet sich bereits ab, dass es dazu einen KB-Eintrag geben wird.
// SH: Sobald ein Prozess für wechselseitiges Verlinken (KB < > HB) mit Matthew Hierholzer abgestimmt ist, könnten wir die KB-Lösung einbinden.

// ML: Oder mach es Dir einfach, lies eine der pem-Dateien aus und füge den Kram als Terminal-Session ein - würde dem Artikel was Hübsches hinzufügen ;) Etwa so:
////
[{shell}]
----
{c-user} while openssl x509 -noout -text; do :; done < ca.pem
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            6a:c7:03:96:e7:e1:f9:09:04:d5:65:91:21:e8:ba:80:c4:74:85:46
        Signature Algorithm: sha512WithRSAEncryption
        Issuer: CN = Site 'mysite_pro' local CA, O = Checkmk Site mysite_pro
        Validity
            Not Before: Nov  7 14:50:38 2025 GMT
            Not After : Nov  7 14:50:38 2035 GMT
        Subject: CN = Site 'mysite_pro' local CA, O = Checkmk Site mysite_pro
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:b3:6d:d4:f9:35:d6:2d:fd:1f:aa:5d:ec:26:0b:

----
////
// TK: Dass man per openssl-Befehl selbst in die Zertifikatsdetails reinschauen kann, finde ich interessant, würde das aber nur ganz hinten im Artikel als neues Kapitel anhängen.
// TK: Kann für Dich ganz interessant sein, um zu sehen, welche der Zertifikatsdetails wie in der GUI aufbereitet werden.
// TK: Bytheway: openssl x509 -in ca.pem -text scheint genauso zu funktionieren und ist für mich leichter lesbar als Mircos Befehl.
// TK: In der Befehlszeile den kompletten Pfad zum Instanzverzeichnis angeben: ~/etc/ssl/ca.pem, sonst funktioniert weder der eine noch der andere Befehl.
// SH: Solange die Subject alternative names (Werk 18) nicht in der Software enthalten sind und die Download-Buttons, sollten wir das noch nicht einbauen. 
// SH: Für 2.5.0 eine interessante Zusatz-Info, zum gegenwärtigen Zeitpunkt (21.11.2025) hat das Script im Artikel nichts zu suchen, sagt MFS. 

// SH: MFS betonte, dass wir einen Satz zum Ausschluss von Vollständigkeit hineintexten müssten. Allerdings kann die Certificate Overview Page im jetzigen Zustand vom User gar nicht erweitert werden, soweit ich Maximilian Wirtz verstanden habe. Zumindest nicht in absehbarer Zeit. 
// TK: Ich bin da nicht bei MFS. Der Satz "Die Liste erhebt keinen Anspruch auf Vollständigkeit." gefällt mir gar nicht. Keine Vollständigkeit liest sich so, als ob wir bei Checkmk nicht wissen, was wir mitliefern.
// TK: Aber: Ausweg? Warum überhaupt eine Aussage zur Vollständigkeit treffen?
// SH: Nach Rücksprache mit MFS: Nö. Wir treffen keine Aussage dazu und lassen die Admonition weg (oben auskommentiert). 

// SH: Noch zu lösen: 
// TK: Spalte Komponente: Ist nicht besonders treffend benannt (wie Du ja selbst angemerkt hast). Evtl. Weiterführende Informationen? Das setzt aber voraus, dass es immer einen Handbuchlink gibt.
// TK: Spalte Komponente: Direkt in das Kapitel verlinken, wo auch was zu Deinem Thema steht. Wenn da nichts steht, dann besser einen Glossar-Link einfügen, sofern vorhanden.
// TK: Spalte Komponente: Schon der 1. Link zu Livestatus wirft allerdings Fragen auf. 1. Fundstelle für Zertifikat in diesem Artikel: "Livestatus nutzt ein Zertifikat, welches beim Erstellen der Site automatisch generiert wird. Dieses befindet sich mit allen anderen CA-Zertifikaten, denen die Site vertraut in der Datei var/ssl/ca-certificates.crt." Uff, das hat ja so ziemlich gar nichts mit dem zu tun, was auf Deiner Seite zu sehen ist. 
// SH: Die Zertifikate sind im Handbuch weit verstreut, ich habe nicht überall einen exakten Deep Link. Habe nun überwiegend Glossar-Links eingebaut.
// SH: Zum Livestatus frage ich nochmal Mattias.