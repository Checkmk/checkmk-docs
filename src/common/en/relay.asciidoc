// -*- coding: utf-8 -*-
// IGNORE 
// NONASCII ├─ └─ │ ● ○
include::global_attr.adoc[]
= The {CMK} Relay
:title: The {CMK} Relay
:description: Where a firewall blocks special agent or SNMP communication, the {CMK} Relay can be used to monitor affected hosts.
:experimental:

{related-start}
xref:snmp#[Monitoring via SNMP]
xref:special_agents#[Special agents]
ifdef::onprem[]
xref:distributed_monitoring#[Distributed monitoring]
endif::[]
xref:ports#[Ports]
{related-end}


[#intro]
== Introduction

// ES: Abgrenzung von Szenarien mit air-gapped environments wäre wahrscheinlich hilfreich zur Einordnung

ifdef::onprem[]
{cce-only}
endif::[]
There are cases where a {CMK} site cannot reach the host, for example when firewall configuration blocks incoming traffic for a network.
With
ifdef::onprem[]
{UE}, 
endif::[]
ifdef::saas[]
{CE}, 
endif::[]
the {CMK} Relay can be deployed to collect monitoring data and send it to the monitoring site.

include::include_technical_preview.asciidoc[]

[#relaydiffs]
=== Differences to distributed monitoring

There are notable differences to xref:glossar#distributed_monitoring[distributed monitoring]:
// ES: When to choose which? What are each variant's (dis)advantages?
// MFS: Das hängt stark von vielen Faktoren wie verfügbare Bandbreite und Aufwand von Änderungen an der Firewall ab, daher müssen unsere Nutzer anhand der Eigenschaften selbst entscheiden. Ist bspw. Bandbreite massig verfügbar, aber Firewall-Konfiguration schwierig, wird man auch bei hunderten Hosts zum Relay greifen, umgekehrt bei geringer Bandbreite und viel Paketverlust auch bei Dutzenden eine eigene Site im betreffenden Netz ausrollen. 

* _The communication direction:_ The Relay always xref:ports#relay[sends data] to the monitoring site.
* _The place of data processing:_ The Relay neither processes, nor stores data, it just collects monitoring data and passes it on.

// ES: Aktuell erwähnt der Artikel Multi-Tenancy-Umgebungen gar nicht. Muss dort irgendwas besonderes beachtet werden beim Einsatz des Relays? In jedem Fall wäre eine kurze Erwähnung nützlich, zumindest um klarzustellen, ob das Feature in Ultimate MT verfügbar ist. Evtl kurz beschreiben, wie es sich in ein bestehendes Setup einfügt
// MFS: Nicht sehr sinnvoll.

ifdef::onprem[]
Using the Relay in _combination_ with distributed monitoring is limited to the central site currently.
This also means that there is typically no practical use for it in environments using {ME} as intended. 
endif::[]

[#scope]
=== Scope of functionality

The current state of the Relay supports functionality as follows:

// MFS: Soon to be implemented
// * Host checks via ICMP
* A growing selection of xref:special_agents#[special agents]
* Monitoring via xref:snmp#[SNMP]

Current work on extending functionality towards running active checks is under way.
Prioritizing special agent additions is depending on user benefit and effort needed.

[#platforms]
=== Supported platforms

The {CMK} Relay is distributed link:https://hub.docker.com/r/checkmk/check-mk-relay[as a container^] for the _x86-64_ platform.
In general, any container runtime on any recent Linux distribution can be used, but {CMK} only provides full support for a limited set of combinations.

Currently, Ubuntu Linux 24.04 and Red Hat Enterprise Linux 10 are fully supported.
For these distributions, we provide an installation script that requires the distribution-supplied link:https://podman.io/[Podman^] to be present.
We decided for Podman since its tight integration with Systemd facilitates automatic updates of the Relay container.
// ES: explicitly name the package required for the distribution-supplied Podman installation, at least for the two supported OSes?

.The Relay on Windows
[%collapsible]
====
We are currently in progress testing the Relay on Windows.
To be precise: on _Windows Subsystem for Linux_ (aka WSL).
So far, we had positive results with WSL2, with Systemd enabled, using the latest stable WSL2 (2.6.3 as of the time the article last being edited) and running Ubuntu 24.04 atop.

Windows Server 2025 enables all dependencies needed by just running:

[{powershell}]
----
PS C:\whatever> wsl.exe --install
PS C:\whatever> wsl.exe --update
PS C:\whatever> wsl.exe --install -d Ubuntu
----

For older Windows versions, we will create check and installation scripts during {CMK} {v25} beta phase.
====

[#setup]
== Setup

For easy download, installation and association, we provide an installation script.
To retrieve the URL of the installation script, navigate to [.guihint]#Setup > Hosts > Relays#.
There, click the button labeled [.guihint]#Add Relay configuration# to start the assistant for configuring a new Relay.

.In the first step, you are presented with the download URL of the installation script
image::relay_wizard.png[alt="Quicksetup for a new Relay showing the first step with a curl command to download the installation script"]
// ES: reminder that the final screenshot should probably show an https download URL

// MFS: Probably not needed anymore, see above
////
At this point, the installation script supports Ubuntu 24.04 and Red Hat Enterprise Linux 10.
Tests with other systems are ongoing, a detailed list of supported distributions, as well as minimum Kernel, Podman and Systemd versions to run on arbitrary distributions will be added until the release of {CMK} {v25}.
////

Follow the instructions the assistant provides.
In the third step, you will be presented with the parameters to run the script.
// ES: may not be the third step anymore, once the new UI texts are included
Execute it as a non-root user and follow the instructions given by the script.
This will download and configure the container with the Relay, install the update service and associate the Relay with the {CMK} site in a single step.

// MFS: Keep the comment for now in case download gets broken again FIXME: remove before release
////
For easy installation and automatic registration of a Relay, we provide a script located in `/opt/omd/versions/{current}.ultimate/share/check_mk/relays/install_relay.sh`.
Copy it to the machine that will be hosting the Relay.
Execute it as non-root user and follow the instructions the scripts emits.
////

[TIP]
====
In case you switch from a root shell to an unprivileged user, use `su -l username` to make sure to run a complete login shell.
Otherwise, the `systemd` user session is missing and the installation will fail.
====

// MFS: Can be moved down to troubleshooting later
After installation, check the running state with the following commands:

[{shell}]
----
{c-user} systemctl --user status checkmk_relay
● checkmk_relay.service - Checkmk Relay Container
     Loaded: loaded (/home/ubuntu/.config/containers/systemd/checkmk_relay.container; generated)
     Active: [.green]#active (running)# since Tue 2026-01-20 09:53:01 UTC; 1h 52min ago
   Main PID: 942 (conmon)
      Tasks: 23 (limit: 4645)
     Memory: 634.0M (peak: 650.7M)
        CPU: 1min 11.861s
     CGroup: /user.slice/user-1000.slice/user@1000.service/app.slice/checkmk_relay.service
             ├─libpod-payload-5b5a41f0f9106ef18cd1006ffc9488f5e1e5bbe15d6196b1b40681efa220caaa
             │ ├─ 946 sh -c "cmk-relay daemon"
             │ ├─ 955 python3 /opt/check-mk-relay/bin/cmk-relay daemon
             │ ├─ 990 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─ 991 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─1003 python3 -m cmk.fetcher_helper.fetch_ad_hoc
             │ ├─1004 python3 -m cmk.fetcher_helper.fetch_ad_hoc
             └─runtime
{c-user} podman container list
CONTAINER ID  IMAGE                                COMMAND            CREATED   STATUS   PORTS NAMES
5b5a41f0f910  localhost/checkmk_relay:checkmk_sync sh -c cmk-relay... 2 hrs ago Up 2 hrs       checkmk_relay-container
----

////
ES: Ich erhalte beim ersten Befehl noch weitere Ausgabezeilen, ist das Absicht oder irgendein Debug-Print, was noch deaktiviert werden sollte? Ich meine vor allem die Zeilen da unten mit Timestamp. Die Site ist eine Checkmk Ultimate (formerly Cloud) 2.5.0-2026.01.23
(Ansonsten sollte der Text darauf hinweisen, dass die hier gezeigte Ausgabe gekürzt ist)

● checkmk_relay.service - Checkmk Relay Container
     Loaded: loaded (/home/ubuntu/.config/containers/systemd/checkmk_relay.container; generated)
     Active: active (running) since Fri 2026-01-23 10:05:23 UTC; 9min ago
   Main PID: 6773 (conmon)
      Tasks: 23 (limit: 4646)
     Memory: 535.6M (peak: 547.0M)
        CPU: 8.701s
     CGroup: /user.slice/user-1000.slice/user@1000.service/app.slice/checkmk_relay.service
             ├─libpod-payload-bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3
             │ ├─6775 sh -c "cmk-relay daemon"
             │ ├─6777 python3 /opt/check-mk-relay/bin/cmk-relay daemon
             │ ├─6790 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6791 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6792 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6793 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6794 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6795 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6796 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6797 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6798 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6799 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6800 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6801 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6802 python3 /opt/check-mk-relay/bin/fetcher
             │ ├─6803 python3 -m cmk.fetcher_helper.fetch_ad_hoc
             │ ├─6804 python3 -m cmk.fetcher_helper.fetch_ad_hoc
             │ ├─6805 python3 -m cmk.fetcher_helper.fetch_ad_hoc
             │ └─6806 python3 -m cmk.fetcher_helper.fetch_ad_hoc
             └─runtime
               ├─6769 /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp --enable-ipv6 -c -r 3 -e 4 --netns-type=path /run/user/1000/netns/netns-65bd96d5-484d-aba6-8345-a60785137a3d tap0
               └─6773 /usr/bin/conmon --api-version 1 -c bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3 -u bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3 -r /usr/bin/crun -b /home/ubuntu/.local/share/containers/storage/overlay-containers/bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3/userdata -p /run/user/1000/containers/overlay-containers/bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3/userdata/pidfile -n checkmk_relay-container --exit-dir /run/user/1000/libpod/tmp/exits --full-attach -l journald --log-level warning --syslog --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/user/1000/containers/overlay-containers/bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3/userdata/oci-log --conmon-pidfile /run/user/1000/containers/overlay-containers/bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /home/ubuntu/.local/share/containers/storage --exit-command-arg --runroot --exit-command-arg /run/user/1000/containers --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/user/1000/libpod/tmp --exit-command-arg --network-config-dir --exit-command-arg "" --exit-command-arg --network-backend --exit-command-arg netavark --exit-command-arg --volumepath --exit-command-arg /home/ubuntu/.local/share/containers/storage/volumes --exit-command-arg --db-backend --exit-command-arg sqlite --exit-command-arg --transient-store=false --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg --rm --exit-command-arg bcab9d716efd07df79a95b266179e9f5691bbebd3cf2e1c5686fe41d336f0ee3

Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.processors.site_client - INFO - Using serial '-1'
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.processors.configuration - INFO - Configuration processor initialized
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.processors.cert_rotation - INFO - Certificate rotation processor initialized
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.processors.site_version_update - INFO - Site version update processor initialized
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.processors.site - INFO - Site processor initialized
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.schedulers._base - INFO - Starting ServiceScheduler...
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.schedulers._base - INFO - Starting PollScheduler...
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.schedulers._base - INFO - Starting CertRotationScheduler...
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay - INFO - engine started
Jan 23 10:05:24 myrelay checkmk_relay-container[6773]: 2026-01-23 10:05:24,228 - cmk.relay.schedulers.poll - INFO - starting to poll site for tasks at https://198.51.100.104:8000/mysite/
////

On the {CMK} site to which you just added the Relay, run [.guihint]#Activate changes# to complete the registration of the Relay.

[#monitoring]
== Monitoring via Relay

Monitoring via the Relay is straightforward.
When adding a host, activate [.guihint]#Monitored on Relay# and select the Relay that can connect to the host you are adding.
// ES: Die Option "Monitored on Relay" ist im Standardfall erst nach Klick auf "Show more" sichtbar, gerne darauf hinweisen, dass wir im Bereich "Basic settings" danach suchen müssen
Each Relay contacts its associated {CMK} site at least once per minute for configuration updates.
After pulling an updated configuration, it runs special agents and other checks immediately.
Because of this one-minute interval plus the time needed to upload agent output, it can take up to 90 seconds until a service discovery for special agents is successful, and even longer for sluggish SNMP devices.

[#troubleshooting]
== Troubleshooting

Remember, this component of {CMK} is work-in-progress!
While generally quite stable, you might encounter bugs.

[#version]
=== Check the version of the Relay

The version of the Relay container image must match the exact version of the {CMK} site it is connected to.
You can check the version with the `podman images` command:

[{shell}]
----
{c-user} podman images
REPOSITORY                        TAG           IMAGE ID      CREATED       SIZE
docker.io/checkmk/check-mk-relay  {current-major}p1       423f9b67558b  5 months ago  428 MB
localhost/checkmk_relay           checkmk_sync  72c27637aa5a  5 months ago  428 MB
docker.io/checkmk/check-mk-relay  {current-major}p3       72c27637aa5a  5 months ago  428 MB
----

// ES: Warum die fingierten images mit p1 und p3? Ich würde es bevorzugen, die Wahrheit zum Zeitpunkt des Release abzubilden und im Text darauf hinzuweisen, dass in Zukunft neue Patchlevel erscheinen können, auf die man achten muss.

When deployed on Podman, the {CMK} Relay installs a service that automatically updates the container image to the same version as the associated site and restarts the container afterwards.
// ES: Automatically updates when, how often, triggered by what? Can any monitoring data get lost during the restart? Does the site admin have any control over delaying/timing the update and restart? What can go wrong in the worst case?
// MFS: Triggered by detection of a version change of the Checkmk site, should happen immediately, but seems to be outright broken currently.
In case the update fails, check the file `${HOME}/.local/share/checkmk_relay/update-trigger.conf` and edit it to contain the same version as your {CMK} site.
// ES: Wie erfahre ich, dass das Update des Relays failt? Erhalte ich dann einfach plötzlich keine Monitoring-Daten mehr, weil das Relay nicht zur Version der Site passt? Oder sollte der Zustand des Relays irgendwo in meiner Site sichtbar sein (möglicherweise sogar überwacht werden)?
Changes to this file trigger the one-shot service `checkmk_relay-update-manager`.

To check the state of the update manager for the {CMK} Relay, run:

[{shell}]
----
{c-user} systemctl --user status checkmk_relay-update-manager
systemctl --user status checkmk_relay-update-manager
○ checkmk_relay-update-manager.service - Checkmk Relay Update Manager
     Loaded: loaded (/home/ubuntu/.config/systemd/user/checkmk_relay-update-manager.service; enabled; preset: enabled)
     Active: inactive (dead) since Thu 2026-01-22 05:38:13 UTC; 4min 21s ago
TriggeredBy: ● checkmk_relay-update-manager.path
    Process: 1746 ExecStart=/home/ubuntu/.local/bin/checkmk_relay-update-manager.sh (code=exited, status=0/SUCCESS)
   Main PID: 1746 (code=exited, status=0/SUCCESS)
        CPU: 118ms

Jan 22 05:38:13 relay cmk-relay-updater[1748]: Getting image source signatures
Jan 22 05:38:13 relay cmk-relay-updater[1748]: Copying blob sha256:7166bf3b0234384fd6f94875376669eb838df0128a9eada0bbe6ed3ef364f246
Jan 22 05:38:13 relay cmk-relay-updater[1748]: Copying blob sha256:76249c7cd50397d2e8c06a75106723d057deaba0ffbc7f4af1bb02bcf71d81cf
Jan 22 05:38:13 relay cmk-relay-updater[1748]: Copying config sha256:e4801f0ceb983046532167b83f0991bb8008146b38820500b00c0e2038274224
Jan 22 05:38:13 relay cmk-relay-updater[1748]: Writing manifest to image destination
Jan 22 05:38:13 relay cmk-relay-updater[1748]: e4801f0ceb983046532167b83f0991bb8008146b38820500b00c0e2038274224
Jan 22 05:38:13 relay podman[1748]: 2026-01-22 05:38:13.73502563 +0000 UTC m=+2.163078855 image pull e4801f0ceb983046532167b83f0991bb800814>
Jan 22 05:38:13 relay podman[1756]: 2026-01-22 05:38:13.750687101 +0000 UTC m=+0.011144376 image tag e4801f0ceb983046532167b83f0991bb800814>
Jan 22 05:38:13 relay cmk-relay-updater[1746]: Update Manager: Update sequence completed.
Jan 22 05:38:13 relay systemd[779]: Finished checkmk_relay-update-manager.service - Checkmk Relay Update Manager.
----

This output shows the state of the last update run.
Here, success was logged.

When manually restarting the service and checking the status immediately afterwards, you might encounter an output like this:

[{shell}]
----
{c-user} systemctl --user status checkmk_relay-update-manager
● checkmk_relay-update-manager.service - Checkmk Relay Update Manager
     Loaded: loaded (/home/ubuntu/.config/systemd/user/checkmk_relay-update-manager.service; enabled; preset: enabled)
     Active: [.green]#activating (start)# since Tue 2026-01-20 17:47:38 CET; 46s ago
TriggeredBy: ● checkmk_relay-update-manager.path
   Main PID: 47108 (checkmk_relay-u)
      Tasks: 12 (limit: 9484)
     Memory: 772.8M (peak: 780.0M)
        CPU: 15.249s
     CGroup: /user.slice/user-1000.slice/user@1000.service/app.slice/checkmk_relay-update-manager.service
             ├─47108 /bin/bash /home/ubuntu/.local/bin/checkmk_relay-update-manager.sh
             └─47110 podman pull docker.io/checkmk/check-mk-relay:{current-major}p3
----

Here, the running `podman pull` process indicates that an update is running and the newest container is currently being downloaded.

[#restart]
=== Restart the container

As hinted above, Podman tightly integrates with Systemd.
Thus, container restarts are simple restarts of Systemd units.
As this is a user-owned unit, make sure to run the command as the user used to install the Relay.

[{shell}]
----
{c-user} systemctl --user restart checkmk_relay
{c-user} systemctl --user status  checkmk_relay
----

[#follow_logs]
=== Tail the container logs

In cases something is not running correctly or your support contact at {com} asks you for log lines, you will want to peek at the container logs.
Use `journalctl` with the `-f` (as in [.guihint]#follow#) option to show ten log lines and print added log lines as well:

[{shell}]
----
{c-user} journalctl --user -u checkmk_relay.service -f
Jan 20 22:28:10 DESKTOP-CJG2U6P checkmk_relay-container[82971]: 2026-01-20 21:28:10,924 - cmk.relay - INFO - distribute main queue task [context: {"id":"'5ecff8bd-710a-4ef0-a185-9b5bb6a31060'","type":"'FetchTask'"}]
Jan 20 22:28:10 DESKTOP-CJG2U6P checkmk_relay-container[82971]: 2026-01-20 21:28:10,924 - cmk.relay.processors.fetcherpool - INFO - Adding task for execution in fetcher pool [context: {"id":"'5ecff8bd-710a-4ef0-a185-9b5bb6a31060'","type":"'FetchTask'"}]
Jan 20 22:28:10 DESKTOP-CJG2U6P checkmk_relay-container[82971]: 2026-01-20 21:28:10,924 - cmk.relay.processors.fetcherpool - INFO - Start working on task [context: {"pid":"7","id":"'5ecff8bd-710a-4ef0-a185-9b5bb6a31060'"}]
Jan 20 22:28:11 DESKTOP-CJG2U6P checkmk_relay-container[82971]: 2026-01-20 21:28:11,125 - cmk.relay - INFO - distribute main queue task [context: {"id":"'5ecff8bd-710a-4ef0-a185-9b5bb6a31060'","type":"'FetchResult'"}]
Jan 20 22:28:11 DESKTOP-CJG2U6P checkmk_relay-container[82971]: 2026-01-20 21:28:11,125 - cmk.relay.processors.site_client - INFO - Submitting Data [context: {"id":"'5ecff8bd-710a-4ef0-a185-9b5bb6a31060'"}]
----


////
mattias@DESKTOP-CJG2U6P:~$ uname -m
x86_64
mattias@DESKTOP-CJG2U6P:~$ cat /proc/sys/kernel/bootloader_type 
255
mattias@DESKTOP-CJG2U6P:~$ cat /proc/sys/kernel/hyperv_record_panic_msg 
1
mattias@DESKTOP-CJG2U6P:~$ uname -r
6.6.87.2-microsoft-standard-WSL2
mattias@DESKTOP-CJG2U6P:~$ uname -m
x86_64
////

















