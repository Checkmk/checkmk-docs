// -*- coding: utf-8 -*-
// IGNORE + %
include::global_attr.adoc[]
= Monitoring Microsoft Azure
:revdate: 2023-06-07
:title: Monitoring Microsoft Azure
:description: The integration of Microsoft Azure into {CMK} enables seamless monitoring of cloud and on-premises in one interface and is described in detail here.


== Introduction

[{image-left}]
image::azure_logo.png[width=140]

{CMK} includes a extensive module for monitoring Microsoft Azure, consisting of a connector to Azure and a comprehensive collection of check plug-ins that retrieve and evaluate various metrics and statuses for you.

In addition to general information about the link:https://checkmk.com/integrations/azure_usagedetails[costs^] that are incurred by your Azure environment 
and the current link:https://checkmk.com/integrations/azure_status[status^] of Azure in your region, 
you can monitor the following Azure products with all editions of {CMK}:

* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_vm[Virtual Machines^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_storageaccounts[Storage Accounts^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_mysql[MySQL Database^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_postgresql[PostgreSQL Database^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_databases[SQL Database^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_load_balancer[Load Balancer^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_virtual_network[Virtual Network Gateways^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_traffic_manager[Traffic Manager^]
* link:https://checkmk.com/integrations?distributions%5B%5D=check_mk&distributions%5B%5D=check_mk_cloud&search=azure_ad[Active Directory (AD) Connect^]
* link:https://checkmk.com/integrations/azure_sites[Webserver^]

With {CCE} you can also include the following products in your monitoring system:

* link:https://checkmk.com/integrations/azure_app_gateway[Application Gateway^]
* link:https://checkmk.com/integrations/azure_vault_backup_containers[Recovery Services vaults^]

A complete listing of all available check plug-ins for monitoring Microsoft Azure can be found in our link:https://checkmk.com/integrations?tags=azure[Catalog of check plug-ins^] and we describe how to include your AKS (Azure Kubernetes Service) clusters in {CMK} in the article xref:monitoring_kubernetes#[Monitoring Kubernetes].


[#preparation]
== Preparing Azure for {CMK}

=== Creating the app

To monitor Azure with {CMK}, you will need your subscription ID and your tenant ID (also known as the ‘Directory ID’).

First, register {CMK} monitoring as an app so that you can work with the Azure API.
The option for this can be found in the link:https://portal.azure.com[Azure portal^] at [.guihint]#Azure Active Directory > App registrations > New registration#:

[{image-border}]
image::azure_register_1.png[]

Assign a name of your choice.
In the example we use `my-check-mk-app`.
This name is only for information.
The reference to the app itself is actually made via a UUID which you will see in a later step.
You don’t need to change anything in the [.guihint]#Supported account types# section.
Setting the [.guihint]#Redirect URI# is optional.

After the creation select the new app from the list of apps. If it does
not appear in the list, query Select [.guihint]#My apps# on [.guihint]#All apps#.
In the details for the app you will also find the [.guihint]#Application (client) ID# that you will
need later. The [.guihint]#Object-ID# is not required.

[{image-border}]
image::azure_register_2.png[]


=== Assigning permissions to the app

In order for your new app to have access rights to the monitoring data, you must assign them here.
On the left of the main navigation page select the [.guihint]#All resources# item, and then select the [.guihint]#Subscriptions#:

[{image-border}]
image::azure_subscriptions.png[]


In this page’s navigation go to [.guihint]#Access Control (IAM)# and select [.guihint]#Add#, and [.guihint]#Add role assignment#:

[{image-border}]
image::azure_access_control.png[]

Now, under role enter [.guihint]#Reader#, under [.guihint]#Assign access to# select the [.guihint]#Azure AD user, group, or service principal# value,
and enter your new app’s name in the [.guihint]#Select# option:

image::azure_role_assignment.jpg[width=380]


=== Creating a key for the app

Now you need a key (a secret) with which {CMK} can log in to the API.
You can create a key in the app settings under [.guihint]#Certificates & secrets#.
Simply click [.guihint]#New client secret# in the [.guihint]#Client secrets# section.

[{image-border}]
image::azure_register_5.png[]

In the following window Microsoft would like you to enter a name of your choice in the [.guihint]#Description# field.
We have chosen `my-check-mk-key` here.
Don’t forget to select the correct time frame for your needs at the [.guihint]#Expires# option.

image::azure_register_6.png[width=175]

The setup under Azure is now complete, and you should now have the following four pieces of information:

. Your subscription ID
. Your tenant ID (also known as the ‘Directory ID’).
. The application ID (client ID) for the [.guihint]#my-check-mk-app# app
. The secret for the key [.guihint]#my-check-mk-key# for this app

If you do not have your tenant ID at hand, find it by hovering over your login name in the tooltip under [.guihint]#Directory#:

image::azure_register_tenant_id.png[width=600]

You can see the subscription ID -- for example on the [.guihint]#Cost Management + Billing# under [.guihint]#My subscriptions#.
*Note*: Nowadays Microsoft does not display this ID as a hash, but instead as a human-readable name.
You can use this new-style name in the usual way.


[#setup]
== Setting up monitoring in {CMK}

=== Creating a host for Azure

Even though you are not dealing with a _physical_ host in Azure, create a host for your Azure directory in {CMK}.
The host name you can define at will.
Important: Because Azure is a service and therefore does not have an IP address or DNS name (the special agent does the access itself),
you must set the [.guihint]#IP address family# to [.guihint]#No IP#.

image::azure_wato_no_ip.png[]

It is best to save with [.guihint]#Save & Finish# at this point, because of course the service discovery cannot work yet.


=== Configuring the Azure agent

Since Azure cannot be queried through the regular {CMK} agent, you now set up the Azure xref:glossar#special_agent[special agent] 
-- which is also known as a xref:datasource_programs#[data source program].
In this situation {CMK} does not contact the destination host over TCP port 6556 as usual, 
instead it calls a utility that communicates with the target system via Azure’s application-specific API.

To do this, under [.guihint]#Setup > Agents > VM, Cloud, Container > Microsoft Azure# create a rule 
whose xref:wato_rules#conditions[conditions] apply exclusively to the Azure host that has just been created.
There you will find the input fields for the IDs and the secret:

image::azure_agent_rule.png[]

Here you can also select the resource groups or resources that you want to monitor.
If you *have not* checked [.guihint]#explicitly specified groups#, all resource groups are automatically monitored.


=== Testing

If you now perform a service discovery on the Azure host, only a single service called [.guihint]#Azure Agent Info# should be detected:

image::azure_services_ok.png[]

If access to the API does not work (because of a wrong ID or bad permissions, for example),
an error message from the Azure API appears in the status text of [.guihint]#Azure Agent Info#:

image::azure_services_fail.png[]


=== Making resource groups available as hosts

For clarity, Azure monitoring in {CMK} has been designed so that each Azure resource group is represented by a logical (so to speak) host in {CMK}.
This is done with the help of a xref:piggyback#[piggyback procedure].
This piggyback will take data from the Azure host using special agents, and within {CMK} redirect it to these resource group hosts.

The resource group hosts do not automatically appear in {CMK}.
Place these hosts either manually or optionally with the xref:dcd#[Dynamic Configuration Daemon (DCD)].
Important -- when doing so the names of the hosts must exactly match the names of the resource groups -- and this is also case-sensitive!
If you are uncertain about the exact spelling of the groups’ names, you can do this directly from the [.guihint]#Azure Agent Info# service on the Azure host.

By the way -- with the `find_piggy_orphans` auxiliary script from the treasures Directory you will find all of the piggyback hosts for which there are data,
but which have not yet been created as a host in {CMK}:

[{shell}]
----
{c-omd} share/doc/check_mk/treasures/find_piggy_orphans
Glastonbury
Woodstock
----

Configure the resource group hosts without an IP address (analogous to the Azure host),
and select [.guihint]#No API integrations, no Checkmk agent# as the agent and [.guihint]#Always use and expect piggyback data# as piggyback.

image::wato_host_no_agent.png[]

If you now perform a service discovery on one of these resource group hosts,
you will find there are additional services that specifically relate to this resource group:

image::azure_services_piggy.png[]

*Tip*: If you want to freely-choose the names of the resource group hosts,
with the [.guihint]#Setup > Agents > Access to Agents > Hostname translation for piggybacked hosts# rule you can define a conversion of resource groups to hosts.


=== Virtual machines (VMs)

When you use Azure to monitor virtual machines which simultaneously serve as your normal host in {CMK}
-- you can use the Azure services associated with those VMs instead of the resource group hosts associated directly with the VM hosts in {CMK}.

To do this, in the Azure rule, under the [.guihint]#Map data relating to VMs# option, select the [.guihint]#Map data to the VM itself# setting.
For this to work the VM’s {CMK} host in monitoring must have exactly the same name as the corresponding VM in Azure.


=== Rate limit for API queries

Currently the API queries that {CMK} needs for monitoring Azure (as opposed to xref:monitoring_aws#[AWS]) are free
-- however there is a limit to the number of queries permitted per time period (the ‘Rate Limit’).
Per application ID the limit is 12,000 read requests per hour.

Due to the structure of the API, {CMK} requires at least one or more queries per requested resource.
Therefore the total number of queries scales linearly with the number of resources being monitored.
If the query limit is reached or exceeded, the query fails with a HTTP code 429 (too many requests), and the [.guihint]#Check_MK# service for the Azure host is flagged as {CRIT}.

This rate limit results from Azure's so-called ‘token bucket’ algorithm.
It all starts with you having a ‘credit’ of 12,000 remaining queries
-- each query consumes one of these.
Simultaneously 3.33 queries per second are added to the credit.
The output of the [.guihint]#Azure Agent Info# service lets you see how many queries are currently left.

Specifically, this means that:

* If your query rate is sufficiently low, the available queries are always just under 12,000.
* If your rate is too high, the credit will slowly go down to 0 and then errors will occur sporadically in the query.

In this case you can reduce the polling rate by querying fewer polling resource groups or resources,
or by reducing the check interval for the [.guihint]#Check_MK# active check on the Azure host.
This is possible with the [.guihint]#Normal check interval for service checks# rule.

So that you can react in time, the [.guihint]#Azure Agent Info# service monitors the number of remaining queries and warns you in advance. By default, for the remaining queries the warning threshold is 50{nbsp}%, and the critical threshold is at 25{nbsp}%.


[#dashboards]
== Dashboards

{CCE-only}
For a convenient start into Azure monitoring, the {CE} includes the two built-in xref:glossar#dashboard[dashboards], [.guihint]#Azure VM instances# and [.guihint]#Azure storage accounts#.
Both of these can be found as menu items in the monitoring under [.guihint]#Monitor > Cloud#.

To provide a clearer impression, following are two examples of how these dashboards are structured.
First, the VM instances dashboard, in which you can compare the current state on the left side and the chronological history of the most important metrics on the right side:

image::monitoring_azure_dashboard_vm.png[alt="Dashboard for the Azure VM instances."]

The dashboard for the storage accounts is structured very similarly.
On the left-hand side, you will find current data for the respective buckets.
On the right, the most important metrics are again displayed chronologically:

image::monitoring_azure_dashboard_storage.png[alt="Dashboard for the Azure storage accounts."]
