// -*- coding: utf-8 -*-
// IGNORE OTel hellolevel p10 p3
// SKIPCOMMITS 2025-09-10
include::global_attr.adoc[]
= Monitoring OpenTelemetry metrics
:revdate: 2025-09-10
:title: Monitoring OpenTelemetry metrics
:description: Starting from {CMK} 2.4.0, OpenTelemetry metrics can experimentally be received by monitoring sites. Read here how to configure and use the connector.

{related-start}
xref:special_agents#[Special agents]
xref:dcd#[Dynamic host management]
{related-end}


include::include_technical_preview.asciidoc[]

[#intro]
== Introduction

{cee-only}
Starting with {CMK} {v24} you can receive link:https://opentelemetry.io/[OpenTelemetry^] metrics from {CCE} onwards, i.e. in {CE} and {ME}, and process them in the monitoring.
For this purpose, {CMK} comes with an OpenTelemetry collector.
This collector supports the _gRPC_ and _HTTP(S)_ transport protocols as recipients in a push configuration.
As a _scraper_, it can also collect data from Prometheus endpoints (in a pull configuration).

Based on any OpenTelemetry services identified, hosts can be created automatically with the xref:dcd#[dynamic host management].
These hosts are then assigned OpenTelemetry xref:glossar#metric[metrics] as {CMK} xref:glossar#service[services] by a xref:glossar#special_agent[special agent].

Briefly summarized: Three components (collector, dynamic host management and special agent) must interact before services can be discovered and metrics generated.
You should therefore configure these three components first and only xref:glossar#activate_changes[activate the pending changes] at the end.

[TIP]
====
This article describes the status of OpenTelemetry integration at the time of release of {CMK} {v24}p10.
We are continuing to work on incorporating subsequent changes from patch releases.
Some of the limitations described have already been fixed and frequently requested features have been added.
Please refer to the link:https://checkmk.com/werks?search=otel&product=cmk&cmk_version%5B%5D=2.4&level%5B%5D=1&level%5B%5D=2&level%5B%5D=3&class%5B%5D=feature&class%5B%5D=fix&class%5B%5D=security&edition=all[OpenTelemetry related Werks^] to find out the current status for the {CMK} version you are using.
====


[#setup]
== Setting up

[#collector_activation]
=== Activating the OpenTelemetry collector

First, you must activate the collector when the site is stopped.
This can be done as the site user on the command line using xref:omd_basics#omd_config[`omd config`] in the text-based configuration menu:

[{shell}]
----
{c-omd} omd config
----

Go to `Addons` and activate `OPENTELEMETRY_COLLECTOR`:

++++
include::screen_opentelemetry_tui_collector.xml[]
++++

You do not need to change the port for the self-monitoring of the collector, as it is set to the next free port from 14317 even if multiple sites are being used.

After activating the collector, start the site again with `omd start`.


[#collector_configuration]
=== Setting up the OpenTelemetry collector

Go to [.guihint]#Setup > Hosts > OpenTelemetry collector (experimental)# and start setting up a new collector by clicking the [.guihint]#Add OpenTelemetry collector configuration# button:

image::opentelemetry_collector_general_properties.png[alt=“The general properties of the OpenTelemetry collector.”]

In [.guihint]#General properties#, assign an ID and a title for the new collector.
For [.guihint]#Site restriction#, you must move at least one entry from the left to the right side.
In the above screenshot, the local xref:glossar#site[site] `mysite` is the only one available.

image::opentelemetry_collector_collector_properties.png[alt=“The specific properties of the OpenTelemetry collector.”]


[#config_basics]
==== Basic settings

Pay attention to the following points in the collector properties:

* You must set up at least one of the two push endpoints (via gRPC or HTTP) or a Prometheus scraper (pull).
The screenshot shows an unencrypted, unauthenticated gRPC endpoint on the default port 4317 on all IPv4 addresses (`0.0.0.0`).

* Create at least one field for the [.guihint]#Host name computation#.
In the example, the simplest option has been selected: the `service.name` field received via OpenTelemetry is used as the host name in {CMK}.
In the xref:user_interface#inline_help[inline help], you can find more information about the options for creating host names from OpenTelemetry data.

[TIP]
====
If you want to create more complex host names, save the collector configuration and activate the changes without adding a rule for [.guihint]#Host name computation#.
Then ensure that xref:test[metrics are sent] to the collector.
If you now add rules for the [.guihint]#Host name computation#, suggestions for the available fields will be displayed.
====


[#ec] 
==== Sending logs to the Event Console

OpenTelemetry also provides options for transferring log messages.
The collector can be configured to transfer these in syslog format via TCP to any applications that can receive syslog messages. In the context of {CMK}, the processing of log messages by the xref:ec#[Event Console] is of interest. You can activate this function with the [guihint]#Send log messages to event console# checkbox.

[TIP]
====
Note that _OpenTelemetry Instrumentation_ already ensures that log messages are sent sparingly.
If it is unclear what is arriving at the {CMK} server, temporarily activate a local `rsyslogd` that listens on port 514/TCP.
This will give you an idea of the incoming data volumes before you proceed with activating the Event Console.
====

Use [.guihint]#Save# to save the collector.


[#dcd]
=== Setting up dynamic host management

To ensure that hosts are created automatically, set up a new xref:dcd#connection_opentelemetry[OpenTelemetry connection] with the dynamic host management.
In preparation -- at least for the first tests -- we recommend creating a separate folder in which you store the automatically-generated OpenTelemetry hosts.

To set up the new connection for the dynamic host management, go to [.guihint]#Setup > Hosts > Dynamic host management > Add connection:#

image::opentelemetry_dcd_connection.png[alt="Properties of an OpenTelemetry connection in the dynamic host management."]

Make the following settings in the [.guihint]#Connection properties# box:

* Set [.guihint]#Connector type# to [.guihint]#OpenTelemetry collector data.#

* The `OpenTelemetryTest` folder is used as the target folder for the new hosts ([.guihint]#Create hosts in#) in the example.

* Set the [.guihint]#Host attributes# according to your system environment. +
Unless you have taken the trouble to create names of existing hosts when setting up the xref:collector_configuration[OpenTelemetry collector], the automatically-created hosts will be _virtual_ hosts that are only used in the context of OpenTelemetry.
You can therefore only use special agents as monitoring agents ([.guihint]#Configured API integrations, no Checkmk agent#) and leave the settings for IP addresses at [.guihint]#No IP#.

* By activating the checkbox at [.guihint]#Service discovery#, you specify that xref:glossar#service_discovery[service discovery] will be performed on the automatically-generated hosts.
This leads to the desired result if the special agent for OpenTelemetry has been configured and is active.

* For the other parameters, you can find more information in the article on xref:dcd#connection_properties_opentelemetry[Dynamic host management].

Complete the new connection with [.guihint]#Save#.


[#special_agent]
=== Configuring the special agent

To ensure that {CMK} services are also generated, at least one configuration of the OpenTelemetry special agent must be created.
The required rule can be found under [.guihint]#Setup > Agents > Other integrations > OpenTelemetry (experimental):#

image::opentelemetry_special_agent.png[alt="The rule for configuring the OpenTelemetry special agent."]

In the [.guihint]#OpenTelemetry (experimental)# box, decide whether you want to monitor the OpenTelemetry collector itself -- via the port that was displayed during xref:collector_activation[activation of the collector].

In the condition for the rule, it is obvious to assign the special agent to the folder in which the hosts will be automatically-created -- in the example, this is the `OpenTelemetryTest` folder.

Save the rule with [.guihint]#Save#.

Now that the three components -- collector, dynamic host management and special agent -- have been configured you should xref:glossar#activate_changes[activate the pending changes].


[#test]
=== Sending test data to the collector

You will probably want to set up the OpenTelemetry collector for {CMK} because _somewhere_ in your IT environment _something_ is already generating _some_ OpenTelemetry metrics.

If this is not yet the case, or if you want to quickly try out the example setup described in this article, you can do so with the link:https://github.com/Checkmk/checkmk-docs/tree/master/examples/opentelemetry[example application "Hello metric"^] provided in our GitHub repository, which runs in a virtual Python environment.

It takes around two to three minutes from the time the first data is sent, the host has been created and the service has been detected, and then becomes visible in the monitoring.
The following image shows the services of the "Hello metric" sample application:

image::opentelemetry_services.png[alt="The OpenTelemetry service created with the 'Hello metric' sample application."]

The host name [.guihint]#hello-metric# is generated from the service name given as an option in the `opentelemetry-instrument` command
-- exactly as specified in the configuration of the xref:collector_configuration[OpenTelemetry collector].
The [.guihint]#OTel metric hellolevel# service name in {CMK} is generated from the name of the metric, with the [.guihint]#OTel metric# prefix added by the special agent.

If you activate the [.guihint]#Monitor the collector# option in the xref:special_agent[special agent configuration], i.e. the self-monitoring of the collector, a number of additional services will be created at the host,

The sample application 'Dice Roll' presented on the OpenTelemetry website works in much the same way as 'Hello metric'.
This sample application is in many respects more practical than 'Hello metric'.
For example, 'Dice Roll' sends OpenTelemetry metrics every time the application server is called (and only then!) and enters the data type 'Counter'. You can use the virtual Python environment created for the 'Hello metric' example to try out the 'Dice Roll' example as well. However, you will also need to install the `flask` Python module (`pip install flask`) and create the `app.py` file in the version extended with metrics, as described in this link:https://opentelemetry.io/docs/languages/python/getting-started/#metrics[instruction^].

In the following call, replace the {CMK} server as the target (here `198.51.100.42` with gRPC port 4317):

[{shell-raw}]
----
{c-user} opentelemetry-instrument \
    --traces_exporter console \
    --metrics_exporter otlp \
    --exporter_otlp_metrics_endpoint http://198.51.100.42:4317 \
    --logs_exporter console \
    --service_name dice-server \
    flask run -p 8080
----

[TIP]
====
The restriction to exactly one data point that applied up to {CMK} {v24}p3 has been removed.
https://checkmk.com/werk/18209[Werk pass:q[#]18209^] describes how {CMK} metric names are generated for OpenTelemetry metrics with multiple data points.
====

Your flask server is now ready and can be accessed at the selected port (here: 8080) to roll a die for each call.
You can see the die data, for example, as output from `curl -v \http://localhost:8080/rolldice`.
Each die roll you trigger in this way is transmitted to {CMK} as a data point.

After a few minutes, the host [.guihint]#dice-server# will appear in the monitoring with the [.guihint]#OTel metric dice.rolls# service.
This has six graphs, `pass:[Value_1__Per_Sec]` to `pass:[Value_6__Per_Sec]`, which correspond to the rates of the numbers one to six rolled so far.
The reason for the conversion is that OpenTelemetry metrics use counters, which can only increment -- a data type that is not provided for in {CMK}.
For a clearer display, Checkmk therefore performs the conversion taking the time component into account.

The screenshot shows one of these graphs, which is based on the once per second calls to `/rolldice` within the monitoring period.

.OpenTelemetry metrics use single and double underscores, and units are appended to the metric name if provided (here: _per sec_, i.e., _per second_).
image::opentelemetry_diceroll_5rate.png[alt=“Graph showing the rate at which the number 5 is rolled.”]


[#threshold] 
=== Customizing services

You can set thresholds and more for services using the [.guihint]#Setup > Services > Service monitoring rules > OpenTelemetry (experimental)# rule.
Here you can set rules for individual or all metrics of a service.
The example screenshot shows the selection of the counter for throws with the number 5, as shown above.
The names of known metrics are accessible via the list or as suggestions while typing.
You can enter metrics that are not yet known but that you know will appear as free text.

Depending on the data type provided by the OpenTelemetry data point, it may be useful to calculate rates.
This is useful for counters, such as for dropped network packets.
If multiple sources provide data that is assigned to the same {CMK} service, you can also specify whether aggregation (e.g., sum or average) should be performed or whether simply the most recent, largest, or smallest data points of an interval should have priority.

image::opentelemetry_service_rules.png[alt=“Setting the service rules.”]


[#files]
== Files and directories

[cols="50,~",options="header"]
|===
|File path |Description
| `~/var/check_mk/otel_collector/host_monitoring/` |This is where OpenTelemetry data is created.
A subdirectory is created for each host.
The files created there are in JSON format.
| `~/var/log/otel-collector.log` |Log file of the OpenTelemetry collector
|`~/tmp/check_mk/otel_collector/self+monitoring/` |Temporary directory in which aggregated data from the collector is stored for evaluation by the special agent.
| `~/tmp/check_mk/otel_collector/autocompleter/` |Temporary directory where files required by the suggestion function (list entries and suggestions when typing) are stored.
|===